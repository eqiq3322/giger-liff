<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>GIGER LIFF</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    /* ... (CSS 樣式保持不變) ... */
    :root { --bd:#ddd; --muted:#666; --from:#f0f7ff; --to:#f7fff0; }
    body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans TC",sans-serif;padding:16px;line-height:1.5}
    h2{margin:0 0 8px} h3{margin:8px 0} h4{margin:8px 0}
    label{display:block;margin:8px 0}
    input,select,textarea{width:100%;box-sizing:border-box;padding:10px;border:1px solid var(--bd);border-radius:10px}
    input[type="file"]{padding:5px}
    input[type="radio"], input[type="checkbox"]{width:auto}
    .radio-label{display:inline-block; margin:0 10px 0 2px; font-weight:normal;}
    button{padding:10px 14px;border-radius:10px;border:1px solid #999;background:#fff;cursor:pointer}
    button[disabled]{opacity:.5;cursor:not-allowed}
    button.smallBtn{padding:4px 8px;font-size:0.9em}
    button.linkBtn{background:none;border:none;color:#007bff;padding:4px;cursor:pointer;text-decoration:underline}
    small{color:var(--muted)}
    .card{border:1px solid var(--bd);border-radius:12px;padding:12px;margin-top:12px;background:#fff}
    .grid{display:grid;gap:8px}
    .g2{grid-template-columns:1fr 1fr}
    .g3{grid-template-columns:1fr 1fr 1fr}
    #error{color:#c00;margin:8px 0;display:none}
    .fromWrap{background:var(--from)}
    .toWrap{background:var(--to)}
    .commute-route-block{border:2px solid #007bff;border-radius:10px;padding:10px;margin-top:12px;background:#f8faff}
    .transport-method-entry{border-top:1px dashed #ccc;padding-top:12px;margin-top:12px}
    .weekday-selector{display:flex;gap:4px;justify-content:space-around;margin-top:8px}
    .weekday-selector label{border:1px solid var(--bd);border-radius:50%;width:32px;height:32px;display:inline-flex;align-items:center;justify-content:center;cursor:pointer; margin: 0;}
    .weekday-selector input[type="checkbox"]{display:none}
    .weekday-selector input[type="checkbox"]:checked + span{background:#007bff;color:#fff;border-color:#007bff;border-radius:50%}
    .weekday-selector input[type="checkbox"]:disabled + span{background:#ccc;color:#888;border-color:#ccc;cursor:not-allowed;}
    .repetition-controls {border: 1px solid #e0e0e0; border-radius: 8px; padding: 10px; margin-top: 8px;}
    .custom-repeat-options { display: none; background: #fafafa; padding: 10px; border-radius: 6px; margin-top: 10px; }
    .repetition-summary { margin-top: 10px; padding: 10px; background: #fff; border: 1px dashed #007bff; border-radius: 6px; display: none; }
    .repetition-summary p { margin:0; font-weight:bold; color: #007bff; }
    .repetition-summary small { color: #333; }
  </style>
</head>
<body>
  <div id="loading">載入中…</div>
  <div id="error"></div>

  <section id="roleAConsent" style="display:none">
    </section>

  <section id="roleA" style="display:none">
    </section>

  <section id="roleADashboard" style="display:none">
    <h2>我的寄件</h2>
    <p>您好，<b id="aDashName"></b></p>
    <div class="card">
      <h4>未完成的訂單</h4>
      <div id="aDashboardList">
        <p>載入中...</p>
      </div>
    </div>
  </section>
  <section id="roleB" style="display:none">
    </section>

  <section id="roleC" style="display:none">
    </section>


  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script>
    // === 換成你的實際值 ===
    const LIFF_ID = "2008451062-KyyOrgXx";
    const BACKEND_URL = "https://script.google.com/macros/s/AKfycbylIfdM47Hh8CzdDS_bpv-vDppo1OUiKH9HzkeQa9YjDkNgyuZjTQipdNg9CLd_DOKETg/exec";
    // =====================

    const $ = (id)=>document.getElementById(id);
    function showError(msg){ const e=$('error'); e.textContent=msg; e.style.display='block'; }

    // —— 條款同意 (A)
    const CONSENT_KEY_A = 'giger_consent_a_v2';
    function hasConsentA(){ try{ const raw=localStorage.getItem(CONSENT_KEY_A); return raw && JSON.parse(raw).agreed; }catch{ return false; } }
    function setConsentA(){ localStorage.setItem(CONSENT_KEY_A, JSON.stringify({agreed:true, ts:Date.now()})); }

    // —— 條款同意 (B)
    const CONSENT_KEY_B = 'giger_consent_b_v1';
    function hasConsentB(){ try{ const raw=localStorage.getItem(CONSENT_KEY_B); return raw && JSON.parse(raw).agreed; }catch{ return false; } }
    function setConsentB(){ localStorage.setItem(CONSENT_KEY_B, JSON.stringify({agreed:true, ts:Date.now()})); }
    
    function show(id, on=true){ const el=$(id); if(el) el.style.display = on ? 'block' : 'none'; }

    function getTodayYYYYMMDD(separator = '/', dateObj = null) {
        const d = dateObj || new Date();
        const y = d.getFullYear();
        const m = String(d.getMonth() + 1).padStart(2, '0');
        const day = String(d.getDate()).padStart(2, '0');
        return `${y}${separator}${m}${separator}${day}`;
    }

    // —— (A/B 共用) 站點資料
    const STOP_DATA = { /* ... (站點資料保持不變) ... */ };

    // —— (A/B 共用) 初始化三層下拉
    function initStationSelectors(prefix){ /* ... (函式保持不變) ... */ }

    // —— (A) 專用函式
    function getPlaceSummary(prefix){ /* ... (函式保持不變) ... */ }
    function fillTimeSelect(sel, withASAP=false){ /* ... (函式保持不變) ... */ }
    function setupFarePreview(){ /* ... (函式保持不變) ... */ }

    // —— LIFF 主流程
    let currentProfile=null, role=null, orderId=null;

    async function main(){
      const params=new URLSearchParams(location.search);
      role=params.get('role')||'A';
      orderId=params.get('orderId')||null;
      // === 步驟 2. 偵測 'view' 參數 ===
      const view = params.get('view') || null; 

      await liff.init({ liffId: LIFF_ID });
      if(!liff.isLoggedIn()){ liff.login(); return; }
      currentProfile = await liff.getProfile();
      
      $('loading').style.display='none'; 
      
      // === 步驟 2. 修改 main 函式的邏輯 ===
      if(role==='A'){ 
          if (view === 'dashboard') {
              initRoleADashboard(); // (新功能) A 的儀表板
          } else if (orderId) {
              // A 查看特定訂單 (未來功能)
              // 暫時先導向建立頁面
              initRoleACreate(); 
          } else {
              initRoleACreate(); // (原 initRoleA) A 的建立訂單頁面
          }
      }
      else if(role==='B'){ 
          if (view === 'dashboard') {
              // initRoleBDashboard(); // (未來功能) B 的儀表板
          } else if (params.get('action') === 'accept' && orderId) {
              // initRoleBAccept(orderId); // (未來功能) B 的接單頁
          } else {
              initRoleBCreate(); // (原 initRoleB) B 的註冊頁面
          }
      }
      else if(role==='C'){ 
          initRoleC(); 
      }
      // === (結束) 步驟 2 ===
    }

    // === 步驟 3. A 的「建立訂單」 (函式改名) ===
    function initRoleACreate(){ // (原 initRoleA)
      const goForm = ()=>{
        show('roleAConsent', false); show('roleA', true);
        $('aName').textContent = currentProfile.displayName;

        initStationSelectors('from'); initStationSelectors('to');
        setupFarePreview();
        fillTimeSelect($('pickupTime'), true);
        fillTimeSelect($('deliveryTime'), false);

        const form=$('formA');
        form.addEventListener('submit', async (e)=>{
          e.preventDefault();
          // ... (A 建立訂單的提交邏輯) ...
        });
        $('copyBtn').addEventListener('click', async ()=>{
          // ... (A 複製連結的邏輯) ...
        });
      };
      const goConsent = ()=>{
        show('roleA', false); show('roleAConsent', true);
        const c1=$('consent_chk1'), c2=$('consent_chk2'), c3=$('consent_chk3'), btn=$('btnConsentAgree');
        function refresh(){ btn.disabled = !(c1.checked && c2.checked && c3.checked); }
        [c1,c2,c3].forEach(x=>x.addEventListener('change', refresh)); refresh();
        btn.addEventListener('click', ()=>{ setConsentA(); goForm(); });
        $('btnConsentCancel').addEventListener('click', ()=>{
          if(liff?.closeWindow) liff.closeWindow(); else location.href='https://line.me/R/';
        });
      };
      if(hasConsentA()) goForm(); else goConsent();
    }

    // === 步驟 1. A 的「寄件儀表板」(新函式) ===
    async function initRoleADashboard() {
      try {
        show('roleADashboard', true);
        $('aDashName').textContent = currentProfile.displayName;
        const listContainer = $('aDashboardList');
        
        const payload = {
          action: 'getMyOrdersAsA',
          oaUserId: currentProfile.userId
        };

        const res = await fetch(BACKEND_URL, {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify(payload)
        });
        const json = await res.json();

        if (json.status !== 'success') throw new Error(json.message || '查詢失敗');

        if (!json.orders || json.orders.length === 0) {
          listContainer.innerHTML = '<p>您目前沒有未完成的寄件訂單。</p>';
          return;
        }

        // 動態渲染訂單列表
        let html = '';
        json.orders.forEach(order => {
          // (後端 GAS 需回傳 orderId, itemDesc, fromStation, toStation, statusText)
          html += `
            <div class="card" style="margin-top:8px; background:#f9f9f9;">
              <p style="margin:0; font-size:0.9em; color:#666;">訂單 #${order.orderId || 'N/A'}</p>
              <h4 style="margin:4px 0;">${order.itemDesc || '物品描述'}</h4>
              <p style="margin:4px 0;">從: ${order.fromStation || 'N/A'}</p>
              <p style="margin:4px 0;">到: ${order.toStation || 'N/A'}</p>
              <p style="margin:8px 0;"><strong>狀態：${order.statusText || '處理中'}</strong></p>
              <button type="button" class="view-a-order-btn" data-orderid="${order.orderId}">查看詳情</button>
            </div>
          `;
        });
        listContainer.innerHTML = html;

        // 綁定「查看詳情」按鈕事件
        document.querySelectorAll('.view-a-order-btn').forEach(btn => {
          btn.addEventListener('click', () => {
            const oid = btn.getAttribute('data-orderid');
            // 暫時先讓 A 查看 C 的頁面
            const cLink = `https://liff.line.me/${LIFF_ID}?role=C&orderId=${oid}`;
            if (liff.isInClient()) {
              liff.openWindow({ url: cLink });
            } else {
              location.href = cLink;
            }
          });
        });

      } catch (err) {
        showError('載入 A 儀表板失敗：' + err.message);
        $('aDashboardList').innerHTML = '<p style="color:#c00">載入訂單失敗。</p>';
      }
    }
    // === (結束) A 的「寄件儀表板」 ===


    // === 步驟 3. B 的「註冊」(函式改名) ===
    function initRoleBCreate(){ // (原 initRoleB)
      show('roleB', true);
      $('bName').textContent = currentProfile.displayName;

      const goForm = () => {
        show('roleBConsent', false);
        show('formB', true);
        
        $('addRouteBtn').addEventListener('click', addNewCommuteRoute);
        
        if ($('commuteRoutesContainer').childElementCount === 0) {
          addNewCommuteRoute(); 
        }
        updateAddRouteButtonVisibility(); 

        $('formB').addEventListener('submit', async (e) => {
          e.preventDefault();
          // ... (B 註冊的提交邏輯) ...
        });
      };

      const goConsent = () => {
        show('formB', false); show('roleBConsent', true);
        const c1=$('b_consent_chk1'), c2=$('b_consent_chk2'), c3=$('b_consent_chk3'), btn=$('btnBConsentAgree');
        function refresh(){ btn.disabled = !(c1.checked && c2.checked && c3.checked); }
        [c1,c2,c3].forEach(x=>x.addEventListener('change', refresh)); refresh();
        btn.addEventListener('click', ()=>{ setConsentB(); goForm(); });
        $('btnConsentCancel').addEventListener('click', ()=>{
          if(liff?.closeWindow) liff.closeWindow(); else location.href='https://line.me/R/';
        });
      };
      
      if(hasConsentB()) goForm(); else goConsent();
    }
    
    // (B) 相關的輔助函式 (addNewCommuteRoute, updateAddRouteButtonVisibility, 等等)
    function updateAddRouteButtonVisibility() { /* ... (函式保持不變) ... */ }
    function generateRecurrenceSummary(routeId) { /* ... (函式保持不變) ... */ }
    function updateSummaryUI(routeId) { /* ... (函式保持不變) ... */ }
    function updateRepetitionOptions(routeId) { /* ... (函式保持不變) ... */ }
    function addNewCommuteRoute() { /* ... (函式保持不變) ... */ }

    // (C) 的函式
    async function initRoleC(){
      show('roleC', true);
      $('cName').textContent=currentProfile.displayName;
      if(!orderId){ showError('缺少 orderId'); return; }
      try{
        const payload={ action:'cEnterFromShareLink', oaUserId: currentProfile.userId, name: currentProfile.displayName, orderId };
        const res=await fetch(BACKEND_URL,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
        const json=await res.json();
        if(json.status!=='success') throw new Error(json.message||'failed');
        
        // (後端 GAS 需回傳 order 物件)
        const o=json.order; 
        $('cOrder').innerHTML=`
          <p>訂單編號：${o.orderId}</p>
          <p>開單人：${o.aName}</p>
          <p>起點：${o.fromStation}</p>
          <p>終點：${o.toStation}</p>
          <p>備註：${o.note||''}</p>`;
      }catch(err){ showError('載入訂單失敗：'+err.message); }
    }

    main().catch(err=>{ 
      $('loading').style.display='none'; 
      showError('初始化失敗：'+err.message); 
    });
  </script>
</body>
</html>
