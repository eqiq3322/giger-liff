<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>GIGER LIFF</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { --bd:#ddd; --muted:#666; --from:#f0f7ff; --to:#f7fff0; }
    body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans TC",sans-serif;padding:16px;line-height:1.5}
    h2{margin:0 0 8px} h3{margin:8px 0} h4{margin:8px 0}
    label{display:block;margin:8px 0}
    input,select,textarea{width:100%;box-sizing:border-box;padding:10px;border:1px solid var(--bd);border-radius:10px}
    button{padding:10px 14px;border-radius:10px;border:1px solid #999;background:#fff;cursor:pointer}
    button[disabled]{opacity:.5;cursor:not-allowed}
    button.smallBtn{padding:4px 8px;font-size:0.9em}
    button.linkBtn{background:none;border:none;color:#007bff;padding:4px;cursor:pointer;text-decoration:underline}
    small{color:var(--muted)}
    .card{border:1px solid var(--bd);border-radius:12px;padding:12px;margin-top:12px;background:#fff}
    .grid{display:grid;gap:8px}
    .g2{grid-template-columns:1fr 1fr}
    .g3{grid-template-columns:1fr 1fr 1fr}
    #error{color:#c00;margin:8px 0;display:none}
    .fromWrap{background:var(--from)}
    .toWrap{background:var(--to)}

    /* B 角色專用樣式 */
    .commute-route-block{border:2px solid #007bff;border-radius:10px;padding:10px;margin-top:12px;background:#f8faff}
    .transport-method-entry{border:1px dashed #ccc;border-radius:8px;padding:8px;margin-top:8px}
    .weekday-selector{display:flex;gap:4px;justify-content:space-around;margin-top:8px}
    .weekday-selector label{border:1px solid var(--bd);border-radius:50%;width:32px;height:32px;display:inline-flex;align-items:center;justify-content:center;cursor:pointer}
    .weekday-selector input[type="checkbox"]{display:none}
    .weekday-selector input[type="checkbox"]:checked + span{background:#007bff;color:#fff;border-color:#007bff;border-radius:50%}
  </style>
</head>
<body>
  <div id="loading">載入中…</div>
  <div id="error"></div>

  <section id="roleAConsent" style="display:none">
    <h2>使用條款與隱私告知</h2>
    <div class="card" style="max-height:42vh; overflow:auto">
      <h3 style="margin:0 0 8px">請閱讀以下內容</h3>
      <ul style="margin-left:18px">
        <li>《郵政法》：嚴禁托運任何具通信性質之物品（書信、明信片、文件、合約、發票、單據…）。違規由 A 自負，平台得停權。</li>
        <li>個資與隱私（符合《個資法》）<br>
          蒐集：姓名、電話、位置。<br>
          目的：媒合、送貨、收款。<br>
          分享對象：A 可見 B 資訊；C 可見 B 位置。<br>
          保存期限：達成目的後刪除或去識別化。
        </li>
        <li>禁止站內營業行為；平台不經手運費。建議現金結清；若採轉帳，B 自行承擔確認風險。</li>
        <li>食安與法規遵循：不得託運違禁品、危險品或法規限制物品。</li>
        <li>夜間安全規則：建議交/到貨點選擇「24 小時超商門口」或「有警衛大樓門口」。B 得依自身安全判斷單方取消且不列入爽約。</li>
        <li>大眾運輸誤點風險：B 可能搭乘大眾運輸，時間恐受影響。</li>
        <li>責任限制：除非因平台重大過失，平台不負賠償責任。</li>
        <li>C 收貨失敗時，由 B 主動聯繫 A 協議後續處理。</li>
        <li><b>如果 C 未如約取貨，A 的運費不會退。</b></li>
        <li>Linebot 會廣播媒合所需之訂單資訊與收款方式（A/C）。</li>
      </ul>
    </div>
    <div class="card">
      <label><input type="checkbox" id="consent_chk1"> 我了解並遵守《郵政法》限制。</label>
      <label><input type="checkbox" id="consent_chk2"> 我同意個資蒐集/利用與分享之說明。</label>
      <label><input type="checkbox" id="consent_chk3"> 我了解平台不經手運費與責任限制。</label>
      <div style="display:flex;gap:8px;margin-top:8px">
        <button id="btnConsentAgree" disabled>同意</button>
        <button id="btnConsentCancel" style="border-color:#c00;color:#c00">不同意</button>
      </div>
      <small>請勾選以上三項以啟用「同意」按鈕。</small>
    </div>
  </section>

  <section id="roleA" style="display:none">
    <h2>建立訂單</h2>
    <p>您好，<b id="aName"></b></p>

    <form id="formA" class="card">
      <h3>訂單內容</h3>

      <label>貨物描述（特大/重/長請註明）
        <textarea name="itemDesc" rows="3" placeholder="例如：鞋盒一個、約 2kg，長 40cm" required></textarea>
      </label>

      <fieldset class="card fromWrap" style="border:none">
        <legend><b>交貨點（起點）</b></legend>
        <div class="grid g2">
          <label>系統
            <select id="fromSystem" required></select>
          </label>
          <label>路線
            <select id="fromLine"></select>
          </label>
          <label>站點
            <select id="fromStation"></select>
          </label>
          <label>詳細位置（選填）
            <input id="fromDetail" placeholder="例：超商門口、東側出口 1 號、管理室前">
          </label>
        </div>

        <div class="grid g2">
          <label>交貨時間
            <select id="pickupTime"></select>
          </label>
          <div></div>
        </div>
        <small>夜間建議選「超商門口 / 有警衛大樓門口」。送貨人如判斷不安全有權取消且不記爽約。</small>
      </fieldset>

      <fieldset class="card toWrap" style="border:none">
        <legend><b>到貨點（終點）</b></legend>
        <div class="grid g2">
          <label>系統
            <select id="toSystem" required></select>
          </label>
          <label>路線
            <select id="toLine"></select>
          </label>
          <label>站點
            <select id="toStation"></select>
          </label>
          <label>詳細位置（選填）
            <input id="toDetail" placeholder="例：1 號出口警衛室前、某社區大門口">
          </label>
        </div>

        <div class="grid g2">
          <label>期望送達時間
            <select id="deliveryTime"></select>
          </label>
          <div></div>
        </div>
        <small>以接單人方便的時間為主；若接單者過少，平台將通知協調時間。</small>
      </fieldset>

      <div class="grid g2">
        <label>收貨人稱謂
          <input name="receiverTitle" placeholder="例：王小姐 / 張先生" required>
        </label>
        <label>收貨人電話
          <input name="receiverPhone" inputmode="tel" placeholder="例：0912345678" required>
        </label>
      </div>

      <div class="card" style="background:#fafafa">
        <h4>運費與付款</h4>
        <label><input type="radio" name="payer" value="A" checked> 運費由 A 付款</label>
        <label><input type="radio" name="payer" value="C"> 運費由 C 付款</label>
        <div class="grid g2" style="margin-top:8px">
          <label>基礎運費（固定）
            <input id="baseFare" value="100" readonly>
          </label>
          <label>小費（可選，整數）
            <input id="tip" type="number" min="0" step="10" placeholder="0">
          </label>
        </div>
        <div style="margin-top:6px">預估應付：<b id="farePreview">100</b> 元</div>
        <small>平台不經手款項，建議現金結清。</small>
      </div>

      <label>備註
        <textarea name="note" rows="3" placeholder="例如：易碎、請直立；到站請先致電收貨人"></textarea>
      </label>

      <button type="submit">送出訂單</button>
    </form>

    <div id="aResult" class="card" style="display:none">
      <p>訂單編號：<span id="orderId"></span></p>
      <p>給 C 的連結：</p>
      <input id="shareUrl" readonly>
      <button id="copyBtn">複製連結</button>
    </div>
  </section>

  <section id="roleB" style="display:none">
    <h2>GIGER 夥伴設定</h2>
    <p>您好，<b id="bName"></b></p>

    <div id="roleBConsent">
      <div class="card" style="max-height:42vh; overflow:auto">
        <h3 style="margin:0 0 8px">請詳閱 GIGER 夥伴條款</h3>
        
        <h4>1. 夥伴資格 (KYC)</h4>
        <ul style="margin-left:18px">
          <li>您必須年滿 18 歲。</li>
          <li>您必須提供真實姓名、可驗證的手機號碼、以及與真實姓名同名的銀行帳戶（用於收款）。</li>
        </ul>

        <h4>2. 隱私權與個資告知 (符合《個資法》)</h4>
        <ul style="margin-left:18px">
          <li><b>蒐集資料</b>：姓名、電話、銀行帳戶、即時位置資訊。</li>
          <li><b>蒐集目的</b>：身份驗證 (KYC)、訂單媒合、A/C 聯繫、C 方追蹤貨物位置、運費支付。</li>
          <li><b>分享對象</b>：
            <ul>
              <li>A (寄件人) 將在媒合成功後看到您的稱謂與聯絡資訊。</li>
              <li>C (收件人) 將在您按下「啟程」後，看到您的即時位置，直到「交付完成」或 30 分鐘後。</li>
            </ul>
          </li>
          <li><b>保存期間</b>：依《個資法》規定，於目的消失後刪除或去識別化。</li>
        </ul>

        <h4>3. 付款與風險</h4>
        <ul style="margin-left:18px">
          <li>平台建議以<b>現金收款</b>。</li>
          <li><b>付款風險告知</b>：若您（B）同意接受 A/C 的轉帳，您必須自行承擔確認入帳的責任。<b>切勿僅憑對方出示的「轉帳截圖」交貨</b>，請務必開啟自己的網路銀行或郵局APP，確認款項「確實入帳」後，才可交付物品或啟程。若因未確實核對而受騙，平台概不負責。</li>
        </ul>
        
        <h4>4. 責任與賠償</h4>
        <ul style="margin-left:18px">
          <li>您有妥善保管托運物品的義務。</li>
          <li>若因您的過失導致運送過程物品遺失或毀損，您需負擔相應的賠償與法律責任，平台亦有權將您停權。</li>
        </ul>
        
        <h4>5. 即時位置資訊告知</h4>
        <ul style="margin-left:18px">
          <li>為履行送貨義務及確保 C 能準確取貨，<b>您按下「啟程」後，平台將蒐集您的即時位置資訊，並分享給收貨人 C</b>。</li>
          <li>此資訊將在交付完成或 30 分鐘後自動停止分享與刪除。</li>
        </ul>
      </div>
      <div class="card">
        <label><input type="checkbox" id="b_consent_chk1"> 我確認我已年滿 18 歲，並提供真實資料。</label>
        <label><input type="checkbox" id="b_consent_chk2"> 我已詳閱並同意上述所有隱私權與個資條款。</label>
        <label><input type="checkbox" id="b_consent_chk3"> 我已了解付款風險、賠償責任與位置分享機制。</label>
        <div style="display:flex;gap:8px;margin-top:8px">
          <button id="btnBConsentAgree" disabled>同意並開始設定</button>
          <button id="btnBConsentCancel" style="border-color:#c00;color:#c00">不同意</button>
        </div>
      </div>
    </div>

    <form id="formB" class="card" style="display:none">
      <h3>1. 實名認證 (KYC)</h3>
      <div class="grid g2">
        <label>真實姓名
          <input name="name" placeholder="請填入與銀行帳戶同名" required>
        </label>
        <label>手機號碼
          <input name="phone" inputmode="tel" placeholder="用於 Line 驗證與聯繫" required>
        </label>
      </div>
      <label>銀行帳號（用於收款）
        <input name="bankAccount" placeholder="例：822 (中信) 1234567890" required>
      </label>
      <label><input type="checkbox" name="nameMatch" required> 我確認此銀行帳戶戶名與上述真實姓名相同。</label>

      <hr style="border:0; border-top:1px solid var(--bd); margin:20px 0">

      <h3>2. 通勤路線與時間</h3>
      <p style="margin:0"><small>請設定您可接單的通勤路線與時段。您可以新增多條不同的路線（例如：上班、下班、週末）。</small></p>
      
      <div id="commuteRoutesContainer">
        </div>

      <button type="button" id="addRouteBtn" style="margin-top:12px; width:100%; background:#f0f7ff; border-color:#007bff; color:#007bff"><b>+ 新增通勤路線</b></button>
      
      <hr style="border:0; border-top:1px solid var(--bd); margin:20px 0">
      
      <button type="submit" style="background:#007bff; color:#fff">儲存設定</button>
    </form>
    
    <div id="bResult" class="card" style="display:none">註冊/更新成功！</div>
  </section>

  <section id="roleC" style="display:none">
    <h2>訂單資訊</h2>
    <p>您好，<b id="cName"></b></p>
    <div id="cOrder" class="card">載入中...</div>
  </section>

  <datalist id="stations_trtc">
    <option value="象山"></option><option value="台北101/世貿"></option><option value="信義安和"></option><option value="大安"></option><option value="大安森林公園"></option><option value="東門"></option><option value="中正紀念堂"></option><option value="台大醫院"></option><option value="台北車站"></option><option value="中山"></option><option value="雙連"></option><option value="民權西路"></option><option value="圓山"></option><option value="劍潭"></option><option value="士林"></option><option value="芝山"></option><option value="明德"></option><option value="石牌"></option><option value="唭哩岸"></option><option value="奇岩"></option><option value="北投"></option><option value="復興崗"></option><option value="忠義"></option><option value="關渡"></option><option value="竹圍"></option><option value="紅樹林"></option><option value="淡水"></option><option value="新店"></option><option value="新店區公所"></option><option value="七張"></option><option value="小碧潭"></option><option value="大坪林"></option><option value="景美"></option><option value="萬隆"></option><option value="公館"></option><option value="台電大樓"></option><option value="古亭"></option><option value="小南門"></option><option value="西門"></option><option value="北門"></option><option value="松江南京"></option><option value="南京復興"></option><option value="台北小巨蛋"></option><option value="南京三民"></option><option value="松山"></option><option value="南勢角"></option><option value="景安"></option><option value="永安市場"></option><option value="頂溪"></option><option value="忠孝新生"></option><option value="行天宮"></option><option value="中山國小"></option><option value="大橋頭"></option><option value="台北橋"></option><option value="菜寮"></option><option value="三重"></option><option value="先嗇宮"></option><option value="頭前庄"></option><option value="新莊"></option><option value="輔大"></option><option value="丹鳳"></option><option value="迴龍"></option><option value="三重國小"></option><option value="三和國中"></option><option value="徐匯中學"></option><option value="三民高中"></option><option value="蘆洲"></option><option value="頂埔"></option><option value="永寧"></option><option value="土城"></option><option value="海山"></option><option value="亞東醫院"></option><option value="府中"></option><option value="板橋"></option><option value="新埔"></option><option value="江子翠"></option><option value="龍山寺"></option><option value="善導寺"></option><option value="忠孝復興"></option><option value="忠孝敦化"></option><option value="國父紀念館"></option><option value="市政府"></option><option value="永春"></option><option value="後山埤"></option><option value="昆陽"></option><option value="南港"></option><option value="南港展覽館"></option><option value="動物園"></option><option value="木柵"></option><option value="萬芳社區"></option><option value="萬芳醫院"></option><option value="辛亥"></option><option value="麟光"></option><option value="六張犁"></option><option value="科技大樓"></option><option value="中山國中"></option><option value="松山機場"></option><option value="大直"></option><option value="劍南路"></option><option value="西湖"></option><option value="港墘"></option><option value="文德"></option><option value="內湖"></option><option value="大湖公園"></option><option value="葫洲"></option><option value="東湖"></option><option value="南港軟體園區"></option><option value="新北產業園區"></option><option value="幸福"></option><option value="新北輔大"></option><option value="中原"></option><option value="橋和"></option><option value="中和"></option><option value="景平"></option><option value="中和高中"></option><option value="秀朗橋"></option>
  </datalist>
  <datalist id="stations_krtc">
    <option value="小港"></option><option value="高雄國際機場"></option><option value="草衙"></option><option value="前鎮高中"></option><option value="凱旋"></option><option value="獅甲"></option><option value="三多商圈"></option><option value="中央公園"></option><option value="美麗島"></option><option value="高雄車站"></option><option value="後驛"></option><option value="凹子底"></option><option value="巨蛋"></option><option value="生態園區"></option><option value="左營"></option><option value="世運"></option><option value="西子灣"></option><option value="鹽埕埔"></option><option value="市議會"></option><option value="信義國小"></option><option value="文化中心"></option><option value="五塊厝"></option><option value="技擊館"></option><option value="衛武營"></option><option value="鳳山西"></option><option value="鳳山"></option><option value="大東"></option><option value="鳳山國中"></option><option value="大寮"></option>
  </datalist>
  <datalist id="stations_thsrc">
    <option value="南港"></option><option value="台北"></option><option value="板橋"></option><option value="桃園"></option><option value="新竹"></option><option value="苗栗"></option><option value="台中"></option><option value="彰化"></option><option value="雲林"></option><option value="嘉義"></option><option value="台南"></option><option value="左營"></option>
  </datalist>
  <datalist id="stations_tra">
    <option value="基隆"></option><option value="七堵"></option><option value="汐止"></option><option value="南港"></option><option value="松山"></option><option value="台北"></option><option value="萬華"></option><option value="板橋"></option><option value="樹林"></option><option value="桃園"></option><option value="中壢"></option><option value="新竹"></option><option value="竹南"></option><option value="苗栗"></option><option value="豐原"></option><option value="台中"></option><option value="新烏日"></option><option value="彰化"></option><option value="員林"></option><option value="斗六"></option><option value="嘉義"></option><option value="台南"></option><option value="新營"></option><option value="善化"></option><option value="永康"></option><option value="岡山"></option><option value="新左營"></option><option value="高雄"></option><option value="鳳山"></option><option value="屏東"></option><option value="潮州"></option><option value="宜蘭"></option><option value="羅東"></option><option value="花蓮"></option><option value="台東"></option>
  </datalist>


  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script>
    // === 換成你的實際值 ===
    const LIFF_ID = "2008451062-KyyOrgXx";
    const BACKEND_URL = "https://script.google.com/macros/s/AKfycbylIfdM47Hh8CzdDS_bpv-vDppo1OUiKH9HzkeQa9YjDkNgyuZjTQipdNg9CLd_DOKETg/exec";
    // =====================

    const $ = (id)=>document.getElementById(id);
    function showError(msg){ const e=$('error'); e.textContent=msg; e.style.display='block'; }

    // —— 條款同意 (A)
    const CONSENT_KEY_A = 'giger_consent_a_v2';
    function hasConsentA(){ try{ const raw=localStorage.getItem(CONSENT_KEY_A); return raw && JSON.parse(raw).agreed; }catch{ return false; } }
    function setConsentA(){ localStorage.setItem(CONSENT_KEY_A, JSON.stringify({agreed:true, ts:Date.now()})); }

    // —— 條款同意 (B) (新)
    const CONSENT_KEY_B = 'giger_consent_b_v1';
    function hasConsentB(){ try{ const raw=localStorage.getItem(CONSENT_KEY_B); return raw && JSON.parse(raw).agreed; }catch{ return false; } }
    function setConsentB(){ localStorage.setItem(CONSENT_KEY_B, JSON.stringify({agreed:true, ts:Date.now()})); }
    
    function show(id, on=true){ const el=$(id); if(el) el.style.display=on?'block':'none'; }

    // —— (A) 站點資料：捷運/高捷/高鐵（同前） + 台鐵依縣市分組
    const STOP_DATA = {
      "台北捷運": {
        "淡水信義線 (R)": ["象山","台北101/世貿","信義安和","大安","大安森林公園","東門","中正紀念堂","台大醫院","台北車站","中山","雙連","民權西路","圓山","劍潭","士林","芝山","明德","石牌","唭哩岸","奇岩","北投","復興崗","忠義","關渡","竹圍","紅樹林","淡水"],
        "松山新店線 (G)": ["新店","新店區公所","七張","小碧潭","大坪林","景美","萬隆","公館","台電大樓","古亭","中正紀念堂","小南門","西門","北門","中山","松江南京","南京復興","台北小巨蛋","南京三民","松山"],
        "中和新蘆線 (O)": ["南勢角","景安","永安市場","頂溪","古亭","東門","忠孝新生","松江南京","行天宮","中山國O","民權西路","大橋頭","台北橋","菜寮","三重","先嗇宮","頭前庄","新莊","輔大","丹鳳","迴龍","三重國小","三和國中","徐匯中學","三民高中","蘆洲"],
        "板南線 (BL)": ["頂埔","永寧","土城","海山","亞東醫院","府中","板橋","新埔","江子翠","龍山寺","西門","台北車站","善導寺","忠孝新生","忠孝復興","忠孝敦化","國父紀念館","市政府","永春","後山埤","昆陽","南港","南港展覽館"],
        "文湖線 (BR)": ["動物園","木柵","萬芳社區","萬芳醫院","辛亥","麟光","六張犁","科技大樓","大安","忠孝復興","南京復興","中山國中","松山機場","大直","劍南路","西湖","港墘","文德","內湖","大湖公園","葫洲","東湖","南港軟體園區","南港展覽館"],
        "環狀線 (Y)": ["新北產業園區","幸福","新北輔大","頭前庄","中原","橋和","中和","景平","景安","中和高中","秀朗橋"]
      },
      "高雄捷運": {
        "紅線": ["小港","高雄國際機場","草衙","前鎮高中","凱旋","獅甲","三多商圈","中央公園","美麗島","高雄車站","後驛","凹子底","巨蛋","生態園區","左營","世運"],
        "橘線": ["西子灣","鹽埕埔","市議會","美麗島","信義國小","文化中心","五塊厝","技擊館","衛武營","鳳山西","鳳山","大東","鳳山國中","大寮"]
      },
      "高鐵": { "全線": ["南港","台北","板橋","桃園","新竹","苗栗","台中","彰化","雲林","嘉義","台 nutty","左營"] },
      "台鐵（依縣市）": {
        "基隆市": ["基隆","三坑","八堵","七堵","百福","暖暖"],
        "新北市": ["汐止","汐科","五堵","四腳亭","瑞芳","猴硐","三貂嶺","牡丹","雙溪","貢寮","福隆","石城","大里","大溪","龜山","海科館","八斗子"],
        "台北市": ["南港","松山","台北","萬華"],
        "桃園市": ["桃園","內壢","中壢","埔心","楊梅","富岡","新富"],
        "新竹縣": ["湖口","新豐","竹北","北新竹","千甲","新莊","竹中","六家","上員","竹東","橫山","九讚頭","合興","富貴","內灣"],
        "新竹市": ["新竹","香山"],
        "苗栗縣": ["崎頂","竹南","造橋","豐富","苗栗","南勢","銅鑼","三義","日南","大山","後龍","龍港","白沙屯","新埔","通霄","苑裡"],
        "台中市": ["大甲","清水","沙鹿","龍井","大肚","追分","烏日","新烏日","台中","太原","豐原","潭子","大慶"],
        "彰化縣": ["彰化","花壇","大村","員林","永靖","社頭","田中","二水"],
        "南投縣": ["源泉","濁水","龍泉","集集","水里","車埕"],
        "雲林縣": ["林內","石榴","斗六","斗南"],
        "嘉義市": ["嘉北","嘉義"],
        "嘉義縣": ["大林","民雄","水上","南靖"],
        "台南市": ["後壁","新營","柳營","林鳳營","隆田","拔林","善化","新市","永康","台南","保安","仁德","長榮大學","沙崙","大湖","路竹"],
        "高雄市": ["岡山","橋頭","楠梓","新左營","左營","內惟","鼓山","美術館","三塊厝","高雄","鳳山"],
        "屏東縣": ["九曲堂","六塊厝","屏東","歸來","麟洛","西勢","竹田","潮州","崁頂","南州","鎮安","林邊","佳冬","枋寮","加祿","內獅","枋山"],
        "宜蘭縣": ["頭城","頂埔","礁溪","四城","宜蘭","二結","羅東","冬山","新馬","蘇澳新","蘇澳"],
        "花蓮縣": ["東澳","南澳","和平","和仁","崇德","新城","景美","北埔","花蓮","吉安","志學","平和","壽豐","豐田","林榮新光","南平","鳳林","萬榮","光復","大富","富源","瑞穗","三民","玉里","東里","東竹"],
        "台東縣": ["富里","池上","關山","月美","鹿野","山里","台東","知本","太麻里","金崙","瀧溪","大武"]
      },
      "其他": {}
    };

    // —— (B) 縣市鄉鎮資料 (新)
    const DISTRICT_DATA = {
      "基隆市": ["仁愛區", "信義區", "中正區", "中山區", "安樂區", "暖暖區", "七堵區"],
      "台北市": ["中正區", "大同區", "中山區", "松山區", "大安區", "萬華區", "信義區", "士林區", "北投區", "內湖區", "南港區", "文山區"],
      "新北市": ["板橋區", "三重區", "中和區", "永和區", "新莊區", "新店區", "樹林區", "鶯歌區", "三峽區", "淡水區", "汐止區", "瑞芳區", "土城區", "蘆洲區", "五股區", "泰山區", "林口區", "深坑區", "石碇區", "坪林區", "三芝區", "石門區", "八里區", "平溪區", "雙溪區", "貢寮區", "金山區", "萬里區", "烏來區"],
      "台南市": ["中西區", "東區", "南區", "北區", "安平區", "安南區", "永康區", "歸仁區", "新化區", "左鎮區", "玉井區", "楠西區", "南化區", "仁德區", "關廟區", "龍崎區", "官田區", "麻豆區", "佳里區", "西港區", "七股區", "將軍區", "學甲區", "北門區", "新營區", "後壁區", "白河區", "東山區", "六甲區", "下營區", "柳營區", "鹽水區", "善化區", "大內區", "山上區", "新市區", "安定區"],
      "高雄市": ["新興區", "前金區", "苓雅區", "鹽埕區", "鼓山區", "旗津區", "前鎮區", "三民區", "楠梓區", "小港區", "左營區", "仁武區", "大社區", "岡山區", "路竹區", "阿蓮區", "田寮區", "燕巢區", "橋頭區", "梓官區", "彌陀區", "永安區", "湖內區", "鳳山區", "大寮區", "林園區", "鳥松區", "大樹區", "旗山區", "美濃區", "六龜區", "內門區", "杉林區", "甲仙區", "桃源區", "那瑪夏區", "茂林區", "茄萣區"]
      // ... 可自行擴充全台灣資料
    };


    // —— (A) 初始化三層下拉
    function initStationSelectors(prefix){
      const sysSel = $(prefix+'System');
      const lineSel = $(prefix+'Line');
      const staSel = $(prefix+'Station');

      sysSel.innerHTML = '';
      Object.keys(STOP_DATA).forEach(sys=>{
        const o=document.createElement('option'); o.value=sys; o.textContent=sys; sysSel.appendChild(o);
      });

      function refreshLines(){
        const sys = sysSel.value;
        lineSel.innerHTML=''; staSel.innerHTML='';
        const lines = STOP_DATA[sys] ? Object.keys(STOP_DATA[sys]) : [];
        lines.forEach(line=>{
          const o=document.createElement('option'); o.value=line; o.textContent=line; lineSel.appendChild(o);
        });
        refreshStations();
      }
      function refreshStations(){
        const sys=sysSel.value, line=lineSel.value;
        staSel.innerHTML='';
        (STOP_DATA[sys] && STOP_DATA[sys][line] || []).forEach(st=>{
          const o=document.createElement('option'); o.value=st; o.textContent=st; staSel.appendChild(o);
        });
      }
      sysSel.addEventListener('change', refreshLines);
      lineSel.addEventListener('change', refreshStations);
      refreshLines();
    }

    function getPlaceSummary(prefix){
      const sys=$(prefix+'System').value;
      const line=$(prefix+'Line').value;
      const station=$(prefix+'Station').value;
      const detail=$(prefix==='from'? 'fromDetail':'toDetail');
      const extra=$(detail)?$(detail).value.trim():'';
      const text = `${sys} / ${line} / ${station}${ extra? (' / ' + extra): '' }`;
      return {system:sys,line,station,detail:extra,text};
    }

    // —— (A) 時間下拉：從現在起每 15 分到當日 23:45
    function fillTimeSelect(sel, withASAP=false){
      const now=new Date();
      const end=new Date(); end.setHours(23,45,0,0);
      const opts=[];
      if(withASAP){ opts.push({v:'ASAP', t:'盡快（30 分鐘內）'}); }
      // 從下一個 15 分刻度開始
      const start=new Date(now);
      const m=now.getMinutes();
      const add= (15 - (m % 15)) % 15;
      start.setMinutes(m + (add===0?15:add),0,0);
      for(let t=new Date(start); t<=end; t=new Date(t.getTime()+15*60000)){
        const hh=String(t.getHours()).padStart(2,'0');
        const mm=String(t.getMinutes()).padStart(2,'0');
        opts.push({v:`${hh}:${mm}`, t:`今天 ${hh}:${mm}`});
      }
      sel.innerHTML='';
      opts.forEach(o=>{ const opt=document.createElement('option'); opt.value=o.v; opt.textContent=o.t; sel.appendChild(opt); });
    }

    // —— (A) 運費預覽
    function setupFarePreview(){
      const base=$('baseFare'), tip=$('tip'), out=$('farePreview');
      function calc(){ const t=(parseInt(base.value,10)||0)+(parseInt(tip.value,10)||0); out.textContent=t; }
      tip.addEventListener('input', calc); calc();
    }

    // —— LIFF 主流程
    let currentProfile=null, role=null, orderId=null;

    async function main(){
      const params=new URLSearchParams(location.search);
      role=params.get('role')||'A';
      orderId=params.get('orderId')||null;
      if(params.get('resetConsent')==='1') {
        localStorage.removeItem(CONSENT_KEY_A);
        localStorage.removeItem(CONSENT_KEY_B);
      }

      await liff.init({ liffId: LIFF_ID });
      if(!liff.isLoggedIn()){ liff.login(); return; }
      currentProfile = await liff.getProfile();

      $('loading').style.display='none';
      if(role==='A'){ initRoleA(); }
      else if(role==='B'){ initRoleB(); }
      else if(role==='C'){ initRoleC(); }
    }

    function initRoleA(){
      // 先決定顯示「同意頁」或「表單」
      const goForm = ()=>{
        show('roleAConsent', false);
        show('roleA', true);
        $('aName').textContent = currentProfile.displayName;

        initStationSelectors('from'); initStationSelectors('to');
        setupFarePreview();
        fillTimeSelect($('pickupTime'), true);    // 交貨：含「盡快」
        fillTimeSelect($('deliveryTime'), false);// 期望送達：只列時間

        const form=$('formA');
        form.addEventListener('submit', async (e)=>{
          e.preventDefault();
          const from=getPlaceSummary('from'), to=getPlaceSummary('to');
          const fd=new FormData(form);
          const payer=(fd.get('payer')||'A');
          const baseFare=100, tip=parseInt(($('tip').value||'0'),10)||0;

          const payload={
            action:'registerOrderFromA',
            oaUserId: currentProfile.userId,
            name: currentProfile.displayName,

            // 物品與地點
            itemDesc: fd.get('itemDesc'),
            fromStation: from.text,
            toStation: to.text,
            fromSystem: from.system, fromLine: from.line, fromStationName: from.station, fromDetail: from.detail,
            toSystem: to.system, toLine: to.line, toStationName: to.station, toDetail: to.detail,

            // 時間（新）
            pickupTime: $('pickupTime').value,      // 'ASAP' 或 'HH:MM'
            deliveryTime: $('deliveryTime').value,  // 'HH:MM'

            // 收貨人
            receiverTitle: fd.get('receiverTitle'),
            receiverPhone: fd.get('receiverPhone'),

            // 運費
            farePayer: payer, baseFare, tip, totalFare: baseFare+tip,

            // 條款已同意
            agreed: true
          };

          try{
            const res=await fetch(BACKEND_URL,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
            const json=await res.json();
            if(json.status!=='success') throw new Error(json.message||'提交失敗');

            $('orderId').textContent=json.orderId;
            const shareUrl=`https://liff.line.me/${LIFF_ID}?role=C&orderId=${encodeURIComponent(json.orderId)}`;
            $('shareUrl').value=shareUrl;
            $('aResult').style.display='block';
          }catch(err){ showError('送出失敗：'+err.message); }
        });

        $('copyBtn').addEventListener('click', async ()=>{
          try{ await navigator.clipboard.writeText($('shareUrl').value); alert('已複製連結'); }
          catch{ alert('複製失敗，請長按手動複製'); }
        });
      };

      const goConsent = ()=>{
        show('roleA', false); show('roleAConsent', true);
        const c1=$('consent_chk1'), c2=$('consent_chk2'), c3=$('consent_chk3'), btn=$('btnConsentAgree');
        function refresh(){ btn.disabled = !(c1.checked && c2.checked && c3.checked); }
        [c1,c2,c3].forEach(x=>x.addEventListener('change', refresh)); refresh();

        btn.addEventListener('click', ()=>{ setConsentA(); goForm(); });
        $('btnConsentCancel').addEventListener('click', ()=>{
          if(liff?.closeWindow) liff.closeWindow(); else location.href='https://line.me/R/';
        });
      };

      if(hasConsentA()) goForm(); else goConsent();
    }

    // === (B) 角色：全新函式 ===
    
    // (B) 唯一的 route ID 計數器
    let routeCounter = 0;

    // (B) 新增一筆「交通方式」到指定的路線區塊
    function addNewTransportMethod(container, routeId) {
      const methodCount = container.querySelectorAll('.transport-method-entry').length;
      if (methodCount >= 3) {
        alert('最多只能新增 3 種轉乘方式');
        return;
      }
      
      const methodId = `${routeId}_method${methodCount}`;
      const div = document.createElement('div');
      div.className = 'transport-method-entry';
      div.innerHTML = `
        <div class="grid" style="grid-template-columns: 2fr 1fr;">
          <label>方式 ${methodCount + 1}
            <select name="${methodId}_type" class="transport-type-select">
              <option value="">請選擇交通</option>
              <option value="tra">台鐵</option>
              <option value="thsrc">高鐵</option>
              <option value="trtc">台北捷運</option>
              <option value="krtc">高雄捷運</option>
              <option value="other">其他</option>
            </select>
          </label>
          <button type="button" class="linkBtn remove-method-btn" style="align-self:end; color:#c00">移除</button>
        </div>
        <div class="grid g2" style="display:none;" data-input-for="tra thsrc trtc krtc">
          <label>起站
            <input name="${methodId}_start" list="" placeholder="輸入站名">
          </label>
          <label>終站
            <input name="${methodId}_end" list="" placeholder="輸入站名">
          </label>
        </div>
        <div style="display:none;" data-input-for="other">
          <label>請說明交通工具與路線
            <input name="${methodId}_other_desc" placeholder="例：機車 / 100 號公車">
          </label>
        </div>
      `;
      container.appendChild(div);

      // 幫 select 加上事件
      const sel = div.querySelector('.transport-type-select');
      sel.addEventListener('change', (e) => {
        const type = e.target.value;
        const startInput = div.querySelector(`input[name="${methodId}_start"]`);
        const endInput = div.querySelector(`input[name="${methodId}_end"]`);
        
        // 決定 datalist
        let listId = '';
        if (type === 'tra') listId = 'stations_tra';
        else if (type === 'thsrc') listId = 'stations_thsrc';
        else if (type === 'trtc') listId = 'stations_trtc';
        else if (type === 'krtc') listId = 'stations_krtc';

        if(startInput) startInput.setAttribute('list', listId);
        if(endInput) endInput.setAttribute('list', listId);
        
        // 顯示/隱藏對應的欄位
        div.querySelectorAll('[data-input-for]').forEach(el => {
          const show = el.getAttribute('data-input-for').split(' ').includes(type);
          el.style.display = show ? (el.tagName === 'DIV' ? 'block' : 'grid') : 'none';
        });
      });

      // 幫「移除」按鈕加上事件
      div.querySelector('.remove-method-btn').addEventListener('click', () => {
        div.remove();
        // 重新編號 (可選)
      });
    }

    // (B) 填入鄉鎮下拉
    function populateTownships(citySelect, townshipSelect) {
      const city = citySelect.value;
      const towns = DISTRICT_DATA[city] || [];
      townshipSelect.innerHTML = '<option value="">請選擇鄉鎮</option>';
      towns.forEach(town => {
        const o = document.createElement('option');
        o.value = town; o.textContent = town;
        townshipSelect.appendChild(o);
      });
    }

    // (B) 新增一個「通勤路線」區塊
    function addNewCommuteRoute() {
      routeCounter++;
      const routeId = `route${routeCounter}`;
      const div = document.createElement('div');
      div.className = 'commute-route-block';
      div.setAttribute('data-route-id', routeId);
      
      const today = new Date().toISOString().split('T')[0];

      div.innerHTML = `
        <div class="grid" style="grid-template-columns: 1fr auto;">
          <h4 style="margin:0">路線 ${routeCounter}</h4>
          <button type="button" class="linkBtn remove-route-btn" style="color:#c00">移除此路線</button>
        </div>
        
        <div class="grid g3">
          <label>日期
            <input type="date" name="${routeId}_date" value="${today}">
          </label>
          <label>開始時間
            <input type="time" name="${routeId}_startTime" value="08:00">
          </label>
          <label>結束時間
            <input type="time" name="${routeId}_endTime" value="18:00">
          </label>
        </div>
        
        <label style="margin-top:12px; margin-bottom:4px; font-weight:bold;">重複 (可選，選了日期將失效)</label>
        <div class="weekday-selector">
          ${['日','一','二','三','四','五','六'].map((day, i) => `
            <label>
              <input type="checkbox" name="${routeId}_repeat" value="${i}">
              <span>${day}</span>
            </label>
          `).join('')}
        </div>
        
        <label style="margin-top:12px; font-weight:bold;">可接單區域 (縣市 / 鄉鎮)</label>
        <div class="grid g2">
          <label>縣市
            <select name="${routeId}_city" class="city-select">
              <option value="">請選擇縣市</option>
              ${Object.keys(DISTRICT_DATA).map(city => `<option value="${city}">${city}</option>`).join('')}
            </select>
          </label>
          <label>鄉鎮
            <select name="${routeId}_town" class="township-select">
              <option value="">請先選縣市</option>
            </select>
          </label>
        </div>

        <label style="margin-top:12px; font-weight:bold;">通勤交通方式 (最多 3 種)</label>
        <div class="transport-methods-container" data-route-id="${routeId}">
          </div>
        <button type="button" class="smallBtn add-method-btn" style="margin-top:8px;">+ 新增轉乘方式</button>
      `;
      
      $('commuteRoutesContainer').appendChild(div);
      
      // 綁定事件
      const citySelect = div.querySelector('.city-select');
      const townshipSelect = div.querySelector('.township-select');
      citySelect.addEventListener('change', () => populateTownships(citySelect, townshipSelect));

      div.querySelector('.add-method-btn').addEventListener('click', (e) => {
        addNewTransportMethod(div.querySelector('.transport-methods-container'), routeId);
      });
      
      div.querySelector('.remove-route-btn').addEventListener('click', () => {
        if(confirm('確定要移除此路線嗎？')) {
          div.remove();
        }
      });
      
      // 自動新增第一個交通方式
      addNewTransportMethod(div.querySelector('.transport-methods-container'), routeId);
    }


    function initRoleB(){
      show('roleB', true);
      $('bName').textContent = currentProfile.displayName;

      const goForm = () => {
        show('roleBConsent', false);
        show('formB', true);
        
        // 綁定「新增路線」按鈕
        $('addRouteBtn').addEventListener('click', addNewCommuteRoute);
        
        // 預設載入一條路線
        if ($('commuteRoutesContainer').childElementCount === 0) {
          addNewCommuteRoute();
        }

        // 綁定 B 表單提交
        $('formB').addEventListener('submit', async (e) => {
          e.preventDefault();
          const fd = new FormData(e.target);
          
          const kycData = {
            name: fd.get('name'),
            phone: fd.get('phone'),
            bankAccount: fd.get('bankAccount'),
            nameMatch: fd.get('nameMatch') === 'on'
          };
          
          if (!kycData.nameMatch) {
            alert('請勾選「確認銀行帳戶戶名與真實姓名相同」');
            return;
          }

          // 序列化動態路線
          const routes = [];
          document.querySelectorAll('.commute-route-block').forEach(routeEl => {
            const routeId = routeEl.getAttribute('data-route-id');
            const routeData = {
              date: fd.get(`${routeId}_date`),
              startTime: fd.get(`${routeId}_startTime`),
              endTime: fd.get(`${routeId}_endTime`),
              repeat: fd.getAll(`${routeId}_repeat`), // 取得所有勾選的星期
              city: fd.get(`${routeId}_city`),
              town: fd.get(`${routeId}_town`),
              methods: []
            };

            routeEl.querySelectorAll('.transport-method-entry').forEach((methodEl, i) => {
              const methodId = `${routeId}_method${i}`; // 注意：這裡的 i 是 0-based index，但
              // 為了簡單起見，我們假設 name 是動態綁定的...
              // 重新思考：我們應該直接用 querySelector 抓
              const type = methodEl.querySelector('.transport-type-select').value;
              let methodData = { type };

              if (type === 'other') {
                methodData.description = methodEl.querySelector(`input[name*="_other_desc"]`).value;
              } else if (type) {
                methodData.startStation = methodEl.querySelector(`input[name*="_start"]`).value;
                methodData.endStation = methodEl.querySelector(`input[name*="_end"]`).value;
              }
              routeData.methods.push(methodData);
            });
            routes.push(routeData);
          });
          
          if (routes.length === 0 || routes[0].methods.length === 0) {
            alert('請至少設定一條通勤路線並包含至少一種交通方式');
            return;
          }

          const payload = {
            action: 'registerBUser',
            oaUserId: currentProfile.userId,
            profileName: currentProfile.displayName,
            kyc: kycData,
            commuteRoutes: routes, // 這是包含所有路線的陣列
            agreed: true
          };

          // console.log("B 註冊 Payload:", JSON.stringify(payload, null, 2));
          // alert('請看 console');
          // return; // 暫停，先不送出

          try{
            const res = await fetch(BACKEND_URL, {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(payload)});
            const json = await res.json();
            if(json.status!=='success') throw new Error(json.message || 'failed');
            $('bResult').style.display='block';
            $('formB').style.display='none';
          }catch(err){ showError('送出失敗：'+err.message); }
        });
      };

      const goConsent = () => {
        show('formB', false);
        show('roleBConsent', true);
        const c1=$('b_consent_chk1'), c2=$('b_consent_chk2'), c3=$('b_consent_chk3'), btn=$('btnBConsentAgree');
        function refresh(){ btn.disabled = !(c1.checked && c2.checked && c3.checked); }
        [c1,c2,c3].forEach(x=>x.addEventListener('change', refresh)); refresh();

        btn.addEventListener('click', ()=>{ setConsentB(); goForm(); });
        $('btnBConsentCancel').addEventListener('click', ()=>{
          if(liff?.closeWindow) liff.closeWindow(); else location.href='https://line.me/R/';
        });
      };
      
      // B 的註冊流程：檢查 B 的同意
      if(hasConsentB()) goForm(); else goConsent();
    }

    async function initRoleC(){
      show('roleC', true);
      $('cName').textContent=currentProfile.displayName;
      if(!orderId){ showError('缺少 orderId'); return; }
      try{
        const payload={ action:'cEnterFromShareLink', oaUserId: currentProfile.userId, name: currentProfile.displayName, orderId };
        const res=await fetch(BACKEND_URL,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
        const json=await res.json();
        if(json.status!=='success') throw new Error(json.message||'failed');
        const o=json.order;
        $('cOrder').innerHTML=`
          <p>訂單編號：${o.orderId}</p>
          <p>開單人：${o.aName}</p>
          <p>起點：${o.fromStation}</p>
          <p>終點：${o.toStation}</p>
          <p>備註：${o.note||''}</p>`;
      }catch(err){ showError('載入訂單失敗：'+err.message); }
    }

    main().catch(err=>{ $('loading').style.display='none'; showError('初始化失敗：'+err.message); });
  </script>
</body>
</html>
