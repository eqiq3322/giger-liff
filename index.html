<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>GIGER LIFF</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { --bd:#ddd; --muted:#666; --from:#f0f7ff; --to:#f7fff0; }
    body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans TC",sans-serif;padding:16px;line-height:1.5}
    h2{margin:0 0 8px} h3{margin:8px 0} h4{margin:8px 0}
    label{display:block;margin:8px 0}
    input,select,textarea{width:100%;box-sizing:border-box;padding:10px;border:1px solid var(--bd);border-radius:10px}
    input[type="file"]{padding:5px}
    input[type="radio"], input[type="checkbox"]{width:auto}
    .radio-label{display:inline-block; margin:0 10px 0 2px; font-weight:normal;}
    button{padding:10px 14px;border-radius:10px;border:1px solid #999;background:#fff;cursor:pointer}
    button[disabled]{opacity:.5;cursor:not-allowed}
    button.smallBtn{padding:4px 8px;font-size:0.9em}
    button.linkBtn{background:none;border:none;color:#007bff;padding:4px;cursor:pointer;text-decoration:underline}
    small{color:var(--muted)}
    .card{border:1px solid var(--bd);border-radius:12px;padding:12px;margin-top:12px;background:#fff}
    .grid{display:grid;gap:8px}
    .g2{grid-template-columns:1fr 1fr}
    .g3{grid-template-columns:1fr 1fr 1fr}
    #error{color:#c00;margin:8px 0;display:none}
    .fromWrap{background:var(--from)}
    .toWrap{background:var(--to)}
    .commute-route-block{border:2px solid #007bff;border-radius:10px;padding:10px;margin-top:12px;background:#f8faff}
    .transport-method-entry{border-top:1px dashed #ccc;padding-top:12px;margin-top:12px}
    .weekday-selector{display:flex;gap:4px;justify-content:space-around;margin-top:8px}
    .weekday-selector label{border:1px solid var(--bd);border-radius:50%;width:32px;height:32px;display:inline-flex;align-items:center;justify-content:center;cursor:pointer; margin: 0;}
    .weekday-selector input[type="checkbox"]{display:none}
    .weekday-selector input[type="checkbox"]:checked + span{background:#007bff;color:#fff;border-color:#007bff;border-radius:50%}
    .weekday-selector input[type="checkbox"]:disabled + span{background:#ccc;color:#888;border-color:#ccc;cursor:not-allowed;}
    .repetition-controls {border: 1px solid #e0e0e0; border-radius: 8px; padding: 10px; margin-top: 8px;}
    .custom-repeat-options { display: none; background: #fafafa; padding: 10px; border-radius: 6px; margin-top: 10px; }
    .repetition-summary { margin-top: 10px; padding: 10px; background: #fff; border: 1px dashed #007bff; border-radius: 6px; display: none; }
    .repetition-summary p { margin:0; font-weight:bold; color: #007bff; }
    .repetition-summary small { color: #333; }
  </style>
</head>
<body>
  <div id="loading">頛銝凌?/div>
  <div id="error"></div>

  <section id="roleAConsent" style="display:none">
    <h2>雿輻璇狡?蝘???/h2>
    <div class="card" style="max-height:42vh; overflow:auto">
      <h3 style="margin:0 0 8px">隢霈隞乩??批捆</h3>
      <ul style="margin-left:18px">
        <li>??踵????渡???隞颱??琿縑?扯釭銋???訾縑??靽∠???隞嗚?蝝蟡具?佗???閬 A ?芾?嚗像?啣?????/li>
        <li>???蝘?蝚血???瘜?<br>
          ??嚗??閰晞?蝵柴?br>
          ?桃?嚗??疏?甈整?br>
          ?澈撠情嚗 ?航? B 鞈?嚗 ?航? B 雿蔭??br>
          靽???嚗?????芷?霅??
        </li>
        <li>蝳迫蝡?平銵嚗像?唬?蝬??祥?遣霅啁??皜??交頧董嚗 ?芾??踵?蝣箄?憸券??/li>
        <li>憌???閬敺迎?銝?閮?????芸???閬??嗥??/li>
        <li>憭?摰閬?嚗遣霅唬漱/?啗疏暺??4 撠?頞???????霅西?憭扳???? 敺??芾澈摰?斗?格??銝???賜???/li>
        <li>憭抒?撓隤日?憸券嚗 ?航?凋?憭抒?撓嚗????蔣?踴?/li>
        <li>鞎砌遙?嚗??撟喳?之?仃嚗像?唬?鞎??痊隞颯?/li>
        <li>C ?嗉疏憭望?????B 銝餃??舐鼠 A ?降敺?????/li>
        <li><b>憒? C ?芸?蝝?鞎剁?A ??鞎颱????/b></li>
        <li>Linebot ?誨?剖????銋??株?閮??嗆狡?孵?嚗/C嚗?/li>
      </ul>
    </div>
    <div class="card">
      <label><input type="checkbox" id="consent_chk1"> ??閫?蒂?萄???踵????嗚?/label>
      <label><input type="checkbox" id="consent_chk2"> ??????/?拍??鈭思?隤芣???/label>
      <label><input type="checkbox" id="consent_chk3"> ??閫?像?唬?蝬??祥?痊隞駁??嗚?/label>
      <div style="display:flex;gap:8px;margin-top:8px">
        <button id="btnConsentAgree" disabled>??</button>
        <button id="btnConsentCancel" style="border-color:#c00;color:#c00">銝???/button>
      </div>
      <small>隢?訾誑銝??誑???????/small>
    </div>
  </section>

  <section id="roleA" style="display:none">
    <h2>撱箇?閮</h2>
    <p>?典末嚗?b id="aName"></b></p>
    <form id="formA" class="card">
      <h3>閮?批捆</h3>
      <label>鞎函?膩嚗憭????瑁?閮餅?嚗?
        <textarea name="itemDesc" rows="3" placeholder="靘?嚗????? 2kg嚗 40cm" required></textarea>
      </label>
      <fieldset class="card fromWrap" style="border:none">
        <legend><b>鈭方疏暺?韏琿?嚗?/b></legend>
        <div class="grid g2">
          <label>蝟餌絞 <select id="fromSystem" required></select> </label>
          <label>頝舐? <select id="fromLine"></select> </label>
        </div>
        <div class="grid g2">
          <label>蝡? <select id="fromStation"></select> </label>
          <label>閰喟敦雿蔭嚗憛恬? <input id="fromDetail" placeholder="靘?頞?????游??1 ?恣?恕??> </label>
        </div>
        <div class="grid g2">
          <label>鈭方疏?? <select id="pickupTime"></select> </label>
          <div></div>
        </div>
        <small>憭?撱箄降?詻?????/ ?郎銵之璅???疏鈭箏??斗銝??冽?甈?瘨?銝??賜???/small>
      </fieldset>
      <fieldset class="card toWrap" style="border:none">
        <legend><b>?啗疏暺?蝯?嚗?/b></legend>
        <div class="grid g2">
          <label>蝟餌絞 <select id="toSystem" required></select> </label>
          <label>頝舐? <select id="toLine"></select> </label>
        </div>
        <div class="grid g2">
          <label>蝡? <select id="toStation"></select> </label>
          <label>閰喟敦雿蔭嚗憛恬? <input id="toDetail" placeholder="靘?1 ???郎銵恕??蝷曉?憭折???> </label>
        </div>
        <div class="grid g2">
          <label>?????? <select id="deliveryTime"></select> </label>
          <div></div>
        </div>
        <small>隞交?桐犖?嫣噶???銝鳴??交?株?撠?撟喳撠?矽????/small>
      </fieldset>
      <div class="grid g2">
        <label>?嗉疏鈭箇迂雓?<input name="receiverTitle" placeholder="靘???憪?/ 撘萄??? required> </label>
        <label>?嗉疏鈭粹閰?<input name="receiverPhone" inputmode="tel" placeholder="靘?0912345678" required> </label>
      </div>
      <div class="card" style="background:#fafafa">
        <h4>?祥??甈?/h4>
        <label><input type="radio" name="payer" value="A" checked> ?祥??A 隞狡</label>
        <label><input type="radio" name="payer" value="C"> ?祥??C 隞狡</label>
        <div class="grid g2" style="margin-top:8px">
          <label>?箇??祥嚗摰? <input id="baseFare" value="100" readonly> </label>
          <label>撠祥嚗?賂??湔嚗?<input id="tip" type="number" min="0" step="10" placeholder="0"> </label>
        </div>
        <div style="margin-top:6px">?摯??嚗?b id="farePreview">100</b> ??/div>
        <small>撟喳銝??狡??撱箄降?暸?蝯???/small>
      </div>
      <label>?酉 <textarea name="note" rows="3" placeholder="靘?嚗?蝣??渡?嚗蝡???餅鞎其犖"></textarea> </label>
      <button type="submit">?閮</button>
    </form>
    <div id="aResult" class="card" style="display:none">
      <p>閮蝺刻?嚗?span id="orderId"></span></p>
      <p>蝯?C ???嚗?/p>
      <input id="shareUrl" readonly>
      <button id="copyBtn">銴ˊ???</button>
    </div>
  </section>

  <section id="roleADashboard" style="display:none">
    <h2>??撖辣</h2>
    <p>?典末嚗?b id="aDashName"></b></p>
    <div class="card">
      <h4>?芸???閮</h4>
      <div id="aDashboardList">
        <p>頛銝?..</p>
      </div>
    </div>
  </section>
  
  <section id="roleB" style="display:none">
    <h2>GIGER 憭乩撈閮剖?</h2>
    <p>?典末嚗?b id="bName"></b></p>
    <div id="roleBConsent">
      <div class="card" style="max-height:42vh; overflow:auto">
        <h3 style="margin:0 0 8px">隢底??GIGER 憭乩撈璇狡</h3>
        <h4>1. 憭乩撈鞈 (KYC)</h4>
        <ul style="margin-left:18px">
          <li>?典??僑皛?18 甇脯?/li>
          <li>?典???靘?撖血??撽???璈?蝣潦誑???祕憪?????銵董?塚??冽?嗆狡嚗?/li>
        </ul>
        <h4>2. ?梁?甈???? (蝚血???瘜?</h4>
        <ul style="margin-left:18px">
          <li><b>??鞈?</b>嚗??閰晞?銵董?嗚?銵董?嗥???蝵株?閮?/li>
          <li><b>???桃?</b>嚗澈隞賡?霅?(KYC)???桀??/C ?舐鼠? ?寡蕭頩方疏?拐?蝵柴?鞎餅隞?/li>
          <li><b>?澈撠情</b>嚗?
            <ul>
              <li>A (撖辣鈭? 撠慦???敺??唳?迂雓??舐窗鞈???/li>
              <li>C (?嗡辣鈭? 撠?冽?銝?蝔?嚗??唳???蝵殷??游?漱隞??? 30 ??敺?/li>
            </ul>
          </li>
          <li><b>靽???</b>嚗???瘜?摰??潛??憭勗??芷?霅??/li>
        </ul>
        <h4>3. 隞狡?◢??/h4>
        <ul style="margin-left:18px">
          <li>撟喳撱箄降隞?b>?暸??嗆狡</b>??/li>
          <li><b>隞狡憸券?</b>嚗?剁?B嚗????A/C ??撣喉??典??銵?Ⅱ隤撣喟?鞎砌遙??b>???撠?箇內??撣單?漱鞎?/b>嚗??????芸楛?雯頝舫?銵??萄?APP嚗Ⅱ隤狡?Ⅱ撖血撣喋?嚗??臭漱隞??????蝣箏祕?詨???擉?撟喳璁?鞎痊??/li>
        </ul>
        <h4>4. 鞎砌遙????/h4>
        <ul style="margin-left:18px">
          <li>?冽?憒亙?靽恣???拙??儔??/li>
          <li>?亙??函??仃撠??蝔?憭望?瘥???券?鞎??豢?????瘜?鞎砌遙嚗像?唬漲??撠????/li>
        </ul>
        <h4>5. ?單?雿蔭鞈??</h4>
        <ul style="margin-left:18px">
          <li>?箏悼銵疏蝢拙??Ⅱ靽?C ?賣?蝣箏?鞎剁?<b>?冽?銝?蝔?嚗像?啣????函??單?雿蔭鞈?嚗蒂?澈蝯行鞎其犖 C</b>??/li>
          <li>甇方?閮??其漱隞??? 30 ??敺??甇Ｗ?鈭怨??芷??/li>
        </ul>
      </div>
      <div class="card">
        <label><input type="checkbox" id="b_consent_chk1"> ?Ⅱ隤?撌脣僑皛?18 甇莎?銝行?靘?撖西???/label>
        <label><input type="checkbox" id="b_consent_chk2"> ?歇閰喲銝血???餈唳??蝘???璇狡??/label>
        <label><input type="checkbox" id="b_consent_chk3"> ?歇鈭圾隞狡憸券???痊隞餉?雿蔭?澈璈??/label>
        <div style="display:flex;gap:8px;margin-top:8px">
          <button id="btnBConsentAgree" disabled>??銝阡?憪身摰?/button>
          <button id="btnBConsentCancel" style="border-color:#c00;color:#c00">銝???/button>
        </div>
      </div>
    </div>
    <form id="formB" class="card" style="display:none">
      <h3>1. 撖血?隤? (KYC)</h3>
      <div class="grid g2">
        <label>?祕憪?
          <input name="name" placeholder="隢‵?亥??銵董?嗅??? required>
        </label>
        <label>???Ⅳ
          <input name="phone" inputmode="tel" placeholder="?冽 Line 撽?銝蝜? required>
        </label>
      </div>
      <label>?銵董???冽?嗆狡嚗?
        <input name="bankAccount" placeholder="靘?822 (銝凋縑) 1234567890" required>
      </label>
      <label>?銵董?嗥??(摮撠)
        <input type="file" name="bankPhoto" accept="image/*" required>
        <small>隢??喳??怒???董??皜?抒???/small>
      </label>
      <label><input type="checkbox" name="nameMatch" required> ?Ⅱ隤迨?銵董?嗆??銝膩?祕憪??詨???/label>
      <hr style="border:0; border-top:1px solid var(--bd); margin:20px 0">
      <h3>2. ?頝舐?????/h3>
      <p style="margin:0"><small>隢身摰?舀?桃??頝舐???畾萸?臭誑?啣?憭?銝??楝蝺?靘?嚗??准??准望嚗?/small></p>
      <div id="commuteRoutesContainer">
        </div>
      <button type="button" id="addRouteBtn" style="margin-top:12px; width:100%; background:#f0f7ff; border-color:#007bff; color:#007bff"><b>+ ?啣??頝舐?</b></button>
      <hr style="border:0; border-top:1px solid var(--bd); margin:20px 0">
      <button type="submit" style="background:#007bff; color:#fff">?脣?閮剖?</button>
    </form>
    <div id="bResult" class="card" style="display:none">閮剖?撌脣摮?撖拇銝?..</div>
  </section>

  <section id="roleC" style="display:none">
    <h2>閮鞈?</h2>
    <p>?典末嚗?b id="cName"></b></p>
    <div id="cOrder" class="card">頛銝?..</div>
  </section>


  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script>
    // === ??雿?撖阡???===
    const LIFF_ID = "2008451062-KyyOrgXx";
    const BACKEND_URL = "https://script.google.com/macros/s/AKfycbylIfdM47Hh8CzdDS_bpv-vDppo1OUiKH9HzkeQa9YjDkNgyuZjTQipdNg9CLd_DOKETg/exec";
    // =====================

    const $ = (id)=>document.getElementById(id);
    function showError(msg){ const e=$('error'); e.textContent=msg; e.style.display='block'; }

    // ??璇狡?? (A)
    const CONSENT_KEY_A = 'giger_consent_a_v2';
    function hasConsentA(){ try{ const raw=localStorage.getItem(CONSENT_KEY_A); return raw && JSON.parse(raw).agreed; }catch{ return false; } }
    function setConsentA(){ localStorage.setItem(CONSENT_KEY_A, JSON.stringify({agreed:true, ts:Date.now()})); }

    // ??璇狡?? (B)
    const CONSENT_KEY_B = 'giger_consent_b_v1';
    function hasConsentB(){ try{ const raw=localStorage.getItem(CONSENT_KEY_B); return raw && JSON.parse(raw).agreed; }catch{ return false; } }
    function setConsentB(){ localStorage.setItem(CONSENT_KEY_B, JSON.stringify({agreed:true, ts:Date.now()})); }
    
    function show(id, on=true){ const el=$(id); if(el) el.style.display = on ? 'block' : 'none'; }

    function getTodayYYYYMMDD(separator = '/', dateObj = null) {
        const d = dateObj || new Date();
        const y = d.getFullYear();
        const m = String(d.getMonth() + 1).padStart(2, '0');
        const day = String(d.getDate()).padStart(2, '0');
        return `${y}${separator}${m}${separator}${day}`;
    }

    // ??(A/B ?梁) 蝡?鞈?
    const STOP_DATA = {
      "?啣??琿?": {
        "瘛⊥偌靽∠儔蝺?(R)": ["鞊∪控","?啣?101/銝窒","靽∠儔摰?","憭批?","憭批?璉格??砍?","?梢?","銝剜迤蝝敹萄?","?啣之?恍","?啣?頠?","銝剖控","??,"瘞?镼輯楝","?控","?蔬","憯急?","?控","?噸","?喟?","?剖撗?,"憟痔","??","敺抵?撏?,"敹儔","?腹","蝡孵?","蝝邦??,"瘛⊥偌"],
        "?曉控?啣?蝺?(G)": ["?啣?","?啣???祆?","銝撐","撠╡瞏?,"憭批??,"?舐?","?祇?","?祇尹","?圈憭扳?","?支滬","銝剜迤蝝敹萄?","撠??","镼輸?","??","銝剖控","?暹??漪","?漪敺抵?","?啣?撠楊??,"?漪銝?","?曉控"],
        "銝剖??啗?蝺?(O)": ["?閫?,"?臬?","瘞詨?撣","?漯","?支滬","?梢?","敹??啁?","?暹??漪","銵予摰?,"銝剖控??","瘞?镼輯楝","憭扳???,"?啣?璈?,"?祚","銝?","??摰?,"?剖?摨?,"?啗?","頛之","銝寥陶","餈湧?","銝???","銝??葉","敺銝剖飛","銝?擃葉","?散"],
        "?踹?蝺?(BL)": ["??","瘞詨祐","??","瘚瑕控","鈭?恍","摨葉","?踵?","?啣?","瘙?蝧?,"樴控撖?,"镼輸?","?啣?頠?","??撖?,"敹??啁?","敹?敺抵?","敹??血?","?蝝敹菟尹","撣摨?,"瘞豢","敺控??,"?","?葛","?葛撅汗擗?],
        "??蝺?(BR)": ["???,"?冽","?祈蝷曉?","?祈?恍","颲漸","暻?","?剖撐??,"蝘?憭扳?","憭批?","敹?敺抵?","?漪敺抵?","銝剖控?葉","?曉控璈","憭抒","??頝?,"镼踵?","皜臬?","?噸","?扳?","憭扳??砍?","?急散","?望?","?葛頠???","?葛撅汗擗?],
        "?啁?蝺?(Y)": ["?啣??Ｘ平??","撟貊?","?啣?頛之","?剖?摨?,"銝剖?","璈?","銝剖?","?臬像","?臬?","銝剖?擃葉","蝘??"]
      },
      "擃??琿?": {
        "蝝?": ["撠葛","擃???璈","??","?擃葉","?望?","?","銝???","銝剖亢?砍?","蝢?撜?,"擃?頠?","敺?","?孵?摨?,"撌刻?","????","撌衣?","銝?"],
        "璈?": ["镼踹???,"暽賢???,"撣降??,"蝢?撜?,"靽∠儔??","??銝剖?","鈭???,"??尹","銵郎??,"曈喳控镼?,"曈喳控","憭扳","曈喳控?葉","憭批祚"]
      },
      "擃": { "?函?": ["?葛","?啣?","?踵?","獢?","?啁姘","??","?唬葉","敶啣?","?脫?","?儔","?啣?","撌衣?"] },
      "?圈嚗?蝮??嚗?: {
        "?粹?撣?: ["?粹?","銝?","?怠","銝","?曄?","??"],
        "?啣?撣?: ["瘙迫","瘙?","鈭","?鈭?,"?","?渡?","銝?撊?,"?∩號","?漯","鞎Ｗ祚","蝳?","?喳?","憭折?","憭扳漯","樴控","瘚瑞?擗?,"?急?摮?],
        "?啣?撣?: ["?葛","?曉控","?啣?","?祈"],
        "獢?撣?: ["獢?","?批ㄑ","銝剖ㄑ","??","璆?","撖瓷","?啣?"],
        "?啁姘蝮?: ["皝","?啗?","蝡孵?","?蝡?,"?","?啗?","蝡嫣葉","?剖振","銝","蝡寞","璈怠控","銋???,"??","撖眼","?抒"],
        "?啁姘撣?: ["?啁姘","擐控"],
        "??蝮?: ["撏?","蝡孵?","??","鞊?","??","?","?","銝儔","?亙?","憭批控","敺?","樴葛","?賣?撅?,"?啣?","??","?ㄐ"],
        "?唬葉撣?: ["憭抒","皜偌","瘝嘀","樴?","憭扯?","餈賢?","?","?啁???,"?唬葉","憭芸?","鞊?","瞏剖?","憭扳"],
        "敶啣?蝮?: ["敶啣?","?勗?","憭扳?","?⊥?","瘞賊?","蝷暸","?唬葉","鈭偌"],
        "??蝮?: ["皞?","瞈偌","樴?","??","瘞湧?","頠?"],
        "?脫?蝮?: ["?","?單朽","?","??"],
        "?儔撣?: ["??","?儔"],
        "?儔蝮?: ["憭扳?","瘞?","瘞港?","??"],
        "?啣?撣?: ["敺?","?啁?","?喟?","?陶??,"?","??","??","?啣?","瘞詨熒","?啣?","靽?","隞噸","?瑟旨憭批飛","瘝?","憭扳?","頝舐姘"],
        "擃?撣?: ["撗∪控","璈","璆?","?啣椰??,"撌衣?","?扳?","曌控","蝢?擗?,"銝???,"擃?","曈喳控"],
        "撅蝮?: ["銋??,"?剖???,"撅","甇訾?","暻?","镼踹","蝡寧","瞏桀?","撏?","??","?桀?","??","雿喳","?祚","?正","?抒?","?控"],
        "摰蝮?: ["?剖?","??","蝷漯","??","摰","鈭?","蝢","?砍控","?圈收","?噫??,"?噫"],
        "?梯蝮?: ["?望噫","?噫","?像","??","撏噸","?啣?","?舐?","??","?梯","??","敹飛","撟喳?","憯質?","鞊","?旨?啣?","?像","曈單?","?祆旨","?儔","憭批?","撖?","??","銝?","??","?梢?","?梁姘"],
        "?唳蝮?: ["撖?","瘙?","?控","??","暽輸?","撅梢?","?唳","?交","憭芷獄??,"??","?扳漯","憭扳郎"]
      },
      "?嗡?": {} 
    };

    // ??(A/B ?梁) ????撅支???
    function initStationSelectors(prefix){
      const sysSel = $(prefix+'System');
      const lineSel = $(prefix+'Line');
      const staSel = $(prefix+'Station');
      if (!sysSel || !lineSel || !staSel) return; 
      sysSel.innerHTML = '';
      Object.keys(STOP_DATA).forEach(sys=>{
        if (role === 'B' && sys === '?嗡?') return;
        const o=document.createElement('option'); o.value=sys; o.textContent=sys; sysSel.appendChild(o);
      });
      function refreshLines(){
        const sys = sysSel.value;
        lineSel.innerHTML=''; staSel.innerHTML='';
        const lines = STOP_DATA[sys] ? Object.keys(STOP_DATA[sys]) : [];
        lines.forEach(line=>{
          const o=document.createElement('option'); o.value=line; o.textContent=line; lineSel.appendChild(o);
        });
        refreshStations();
      }
      function refreshStations(){
        const sys=sysSel.value, line=lineSel.value;
        staSel.innerHTML='';
        (STOP_DATA[sys] && STOP_DATA[sys][line] || []).forEach(st=>{
          const o=document.createElement('option'); o.value=st; o.textContent=st; staSel.appendChild(o);
        });
      }
      sysSel.addEventListener('change', refreshLines);
      lineSel.addEventListener('change', refreshStations);
      refreshLines();
    }

    // ??(A) 撠?賢?
    function getPlaceSummary(prefix){
      const sys=$(prefix+'System').value;
      const line=$(prefix+'Line').value;
      const station=$(prefix+'Station').value;
      const detail=$(prefix==='from'? 'fromDetail':'toDetail');
      const extra=$(detail)?$(detail).value.trim():'';
      const text = `${sys} / ${line} / ${station}${ extra? (' / ' + extra): '' }`;
      return {system:sys,line,station,detail:extra,text};
    }
    
    function fillTimeSelect(sel, withASAP=false){
      const now=new Date();
      const end=new Date(); end.setHours(23,45,0,0);
      const opts=[];
      if(withASAP){ opts.push({v:'ASAP', t:'?∪翰嚗?0 ???改?'}); }
      const start=new Date(now);
      const m=now.getMinutes();
      const add= (15 - (m % 15)) % 15;
      start.setMinutes(m + (add===0?15:add),0,0);
      for(let t=new Date(start); t<=end; t=new Date(t.getTime()+15*60000)){
        const hh=String(t.getHours()).padStart(2,'0');
        const mm=String(t.getMinutes()).padStart(2,'0');
        opts.push({v:`${hh}:${mm}`, t:`隞予 ${hh}:${mm}`});
      }
      sel.innerHTML='';
      opts.forEach(o=>{ const opt=document.createElement('option'); opt.value=o.v; opt.textContent=o.t; sel.appendChild(opt); });
    }

    function setupFarePreview(){
      const base=$('baseFare'), tip=$('tip'), out=$('farePreview');
      function calc(){ const t=(parseInt(base.value,10)||0)+(parseInt(tip.value,10)||0); out.textContent=t; }
      tip.addEventListener('input', calc); calc();
    }

    // ??LIFF 銝餅?蝔?
    let currentProfile=null, role=null, orderId=null;

    async function main(){
      const params=new URLSearchParams(location.search);
      role=params.get('role')||'A';
      orderId=params.get('orderId')||null;
      const view = params.get('view') || null; 

      await liff.init({ liffId: LIFF_ID });
      if(!liff.isLoggedIn()){ liff.login(); return; }
      currentProfile = await liff.getProfile();
      
      $('loading').style.display='none'; 
      
      if(role==='A'){ 
          if (view === 'dashboard') {
              initRoleADashboard();
          } else if (orderId) {
              // ?急????遣蝡???(?芯??舀??A ?亦??孵?閮)
              initRoleACreate(); 
          } else {
              initRoleACreate(); // A 撱箇?閮?
          }
      }
      else if(role==='B'){ 
          if (view === 'dashboard') {
              // initRoleBDashboard(); // B ??銵冽 (銝?甇?
          } else if (params.get('action') === 'accept' && orderId) {
              // initRoleBAccept(orderId); // B ??桅? (銝?甇?
          } else {
              initRoleBCreate(); // B ?酉????
          }
      }
      else if(role==='C'){ 
          initRoleC(); 
      }
    }

    // === A ?遣蝡??柴?(?賢??孵?) ===
    function initRoleACreate(){ // (??initRoleA)
      const goForm = ()=>{
        show('roleAConsent', false); show('roleA', true);
        $('aName').textContent = currentProfile.displayName;

        initStationSelectors('from'); initStationSelectors('to');
        setupFarePreview();
        fillTimeSelect($('pickupTime'), true);
        fillTimeSelect($('deliveryTime'), false);

        const form=$('formA');
        form.addEventListener('submit', async (e)=>{
          e.preventDefault();
          const from=getPlaceSummary('from'), to=getPlaceSummary('to');
          const fd=new FormData(form);
          const payer=(fd.get('payer')||'A');
          const baseFare=100, tip=parseInt(($('tip').value||'0'),10)||0;
          const payload={
            action:'registerOrderFromA',
            oaUserId: currentProfile.userId,
            name: currentProfile.displayName,
            itemDesc: fd.get('itemDesc'),
            fromStation: from.text,
            toStation: to.text,
            fromSystem: from.system, fromLine: from.line, fromStationName: from.station, fromDetail: from.detail,
            toSystem: to.system, toLine: to.line, toStationName: to.station, toDetail: to.detail,
            pickupTime: $('pickupTime').value,
            deliveryTime: $('deliveryTime').value,
            receiverTitle: fd.get('receiverTitle'),
            receiverPhone: fd.get('receiverPhone'),
            farePayer: payer, baseFare, tip, totalFare: baseFare+tip,
            agreed: true
          };
          try{
            const res=await fetch(BACKEND_URL,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
            const json=await res.json();
            if(json.status!=='success') throw new Error(json.message||'?漱憭望?');
            $('orderId').textContent=json.orderId;
            const shareUrl=`https://liff.line.me/${LIFF_ID}?role=C&orderId=${encodeURIComponent(json.orderId)}`;
            $('shareUrl').value=shareUrl;
            $('aResult').style.display='block';
          }catch(err){ showError('?憭望?嚗?+err.message); }
        });
        $('copyBtn').addEventListener('click', async ()=>{
          try{ await navigator.clipboard.writeText($('shareUrl').value); alert('撌脰?鋆賡??'); }
          catch{ alert('銴ˊ憭望?嚗??瑟???銴ˊ'); }
        });
      };
      const goConsent = ()=>{
        show('roleA', false); show('roleAConsent', true);
        const c1=$('consent_chk1'), c2=$('consent_chk2'), c3=$('consent_chk3'), btn=$('btnConsentAgree');
        function refresh(){ btn.disabled = !(c1.checked && c2.checked && c3.checked); }
        [c1,c2,c3].forEach(x=>x.addEventListener('change', refresh)); refresh();
        btn.addEventListener('click', ()=>{ setConsentA(); goForm(); });
        $('btnConsentCancel').addEventListener('click', ()=>{
          if(liff?.closeWindow) liff.closeWindow(); else location.href='https://line.me/R/';
        });
      };
      if(hasConsentA()) goForm(); else goConsent();
    }

    // === A ??隞嗅?銵冽???啣撘? ===
    async function initRoleADashboard() {
      try {
        show('roleADashboard', true);
        $('aDashName').textContent = currentProfile.displayName;
        const listContainer = $('aDashboardList');
        
        const payload = {
          action: 'getMyOrdersAsA',
          oaUserId: currentProfile.userId
        };

        const res = await fetch(BACKEND_URL, {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify(payload)
        });
        const json = await res.json();

        if (json.status !== 'success') throw new Error(json.message || '?亥岷憭望?');

        if (!json.orders || json.orders.length === 0) {
          listContainer.innerHTML = '<p>?函???摰???隞嗉??柴?/p>';
          return;
        }

        let html = '';
        json.orders.forEach(order => {
          html += `
            <div class="card" style="margin-top:8px; background:#f9f9f9;">
              <p style="margin:0; font-size:0.9em; color:#666;">閮 #${order.orderId || 'N/A'}</p>
              <h4 style="margin:4px 0;">${order.itemDesc || '?拙??膩'}</h4>
              <p style="margin:4px 0;">敺? ${order.fromStation || 'N/A'}</p>
              <p style="margin:4px 0;">?? ${order.toStation || 'N/A'}</p>
              <p style="margin:8px 0;"><strong>???${order.statusText || '??銝?}</strong></p>
              <button type="button" class="view-a-order-btn" data-orderid="${order.orderId}">?亦?閰單?</button>
            </div>
          `;
        });
        listContainer.innerHTML = html;

        document.querySelectorAll('.view-a-order-btn').forEach(btn => {
          btn.addEventListener('click', () => {
            const oid = btn.getAttribute('data-orderid');
            const cLink = `https://liff.line.me/${LIFF_ID}?role=C&orderId=${oid}`;
            if (liff.isInClient()) {
              liff.openWindow({ url: cLink });
            } else {
              location.href = cLink;
            }
          });
        });

      } catch (err) {
        showError('頛 A ?銵冽憭望?嚗? + err.message);
        $('aDashboardList').innerHTML = '<p style="color:#c00">頛閮憭望???/p>';
      }
    }


    // === B ?酉???賢??孵?) ===
    function initRoleBCreate(){ // (??initRoleB)
      show('roleB', true);
      $('bName').textContent = currentProfile.displayName;

      const goForm = () => {
        show('roleBConsent', false);
        show('formB', true);
        
        $('addRouteBtn').addEventListener('click', addNewCommuteRoute);
        
        if ($('commuteRoutesContainer').childElementCount === 0) {
          addNewCommuteRoute(); 
        }
        updateAddRouteButtonVisibility(); 

        $('formB').addEventListener('submit', async (e) => {
          e.preventDefault();
          const form = e.target;
          const formData = new FormData(form);
          formData.append('action', 'registerBUser');
          formData.append('oaUserId', currentProfile.userId);
          formData.append('profileName', currentProfile.displayName);
          formData.append('agreed', true);
          const routes = [];
          document.querySelectorAll('.commute-route-block').forEach((routeEl) => {
            const routeId = routeEl.getAttribute('data-route-id');
            const repeatType = formData.get(`${routeId}_repeatType`);
            const transportType = formData.get(`${routeId}_transportType`);
            const endType = formData.get(`${routeId}_endType`); 
            const routeData = {
              date: formData.get(`${routeId}_date`),
              startTime: formData.get(`${routeId}_startTime`),
              endTime: formData.get(`${routeId}_endTime`),
              repeat: {
                type: repeatType,
                customInterval: (repeatType === 'custom') ? formData.get(`${routeId}_customInterval`) : null,
                customUnit: (repeatType === 'custom') ? formData.get(`${routeId}_customUnit`) : null,
                customDays: (repeatType === 'custom') ? formData.getAll(`${routeId}_customDays`) : [],
                end: {
                  type: endType,
                  date: (endType === 'on') ? formData.get(`${routeId}_endDate`) : null,
                  occurrences: (endType === 'after') ? formData.get(`${routeId}_endOccurrences`) : null
                }
              },
              transport: {
                type: transportType,
                start_system: (transportType !== 'other' && $(`${routeId}_start_System`)) ? $(`${routeId}_start_System`).value : null,
                start_line: (transportType !== 'other' && $(`${routeId}_start_Line`)) ? $(`${routeId}_start_Line`).value : null,
                start_station: (transportType !== 'other' && $(`${routeId}_start_Station`)) ? $(`${routeId}_start_Station`).value : null,
                end_system: (transportType !== 'other' && $(`${routeId}_end_System`)) ? $(`${routeId}_end_System`).value : null,
                end_line: (transportType !== 'other' && $(`${routeId}_end_Line`)) ? $(`${routeId}_end_Line`).value : null,
                end_station: (transportType !== 'other' && $(`${routeId}_end_Station`)) ? $(`${routeId}_end_Station`).value : null,
                other_vehicle: (transportType === 'other') ? formData.get(`${routeId}_other_vehicle`) : null,
                other_start: (transportType === 'other') ? formData.get(`${routeId}_other_start`) : null,
                other_end: (transportType === 'other') ? formData.get(`${routeId}_other_end`) : null,
              }
            };
            routes.push(routeData);
            formData.delete(`${routeId}_date`);
            formData.delete(`${routeId}_startTime`);
            formData.delete(`${routeId}_endTime`);
            formData.delete(`${routeId}_repeatType`);
            formData.delete(`${routeId}_customInterval`);
            formData.delete(`${routeId}_customUnit`);
            formData.getAll(`${routeId}_customDays`).forEach(() => formData.delete(`${routeId}_customDays`));
            formData.delete(`${routeId}_endType`);
            formData.delete(`${routeId}_endDate`);
            formData.delete(`${routeId}_endOccurrences`);
            formData.delete(`${routeId}_transportType`);
            formData.delete(`${routeId}_other_vehicle`);
            formData.delete(`${routeId}_other_start`);
            formData.delete(`${routeId}_other_end`);
          });
          formData.append('commuteRoutes_json', JSON.stringify(routes));
          try{
            const res = await fetch(BACKEND_URL, {
              method:'POST', 
              body: formData 
            });
            const json = await res.json();
            if(json.status!=='success') throw new Error(json.message || 'failed');
            $('bResult').style.display='block';
            $('formB').style.display='none';
          }catch(err){ showError('?憭望?嚗?+err.message); }
        });
      };

      //try 
      const goConsent = () => {
        show('formB', false); show('roleBConsent', true);
        const c1=$('b_consent_chk1'), c2=$('b_consent_chk2'), c3=$('b_consent_chk3'), btn=$('btnBConsentAgree');
        function refresh(){ btn.disabled = !(c1.checked && c2.checked && c3.checked); }
        [c1,c2,c3].forEach(x=>x.addEventListener('change', refresh)); refresh();
        btn.addEventListener('click', ()=>{ setConsentB(); goForm(); });
        $('btnConsentCancel').addEventListener('click', ()=>{
          if(liff?.closeWindow) liff.closeWindow(); else location.href='https://line.me/R/';
        });
      };
      
      if(hasConsentB()) goForm(); else goConsent();
    }
    
    // (B) ?賊????拙撘?
    function updateAddRouteButtonVisibility() {
      const count = $('commuteRoutesContainer').childElementCount;
      $('addRouteBtn').style.display = (count >= 3) ? 'none' : 'block';
    }

    function generateRecurrenceSummary(routeId) {
        const dateInput = $(`${routeId}_date`);
        const repeatSelect = $(`${routeId}_repeatType`);
        if (!dateInput || !repeatSelect) return { summaryText: "???葉...", nextDatesStr: "" };
        const controls = {
            date: dateInput.value,
            type: repeatSelect.value,
            interval: parseInt($(`${routeId}_customInterval`).value, 10) || 1,
            unit: $(`${routeId}_customUnit`).value,
            days: Array.from(document.querySelectorAll(`input[name="${routeId}_customDays"]:checked`)).map(cb => parseInt(cb.value, 10)),
            endType: document.querySelector(`input[name="${routeId}_endType"]:checked`).value,
            endDate: $(`${routeId}_endDate`).value,
            endOccurrences: parseInt($(`${routeId}_endOccurrences`).value, 10) || 1
        };
        const dayNames = ['??, '銝', '鈭?, '銝?, '??, '鈭?, '??];
        let summaryText = "";
        let nextDates = [];
        let currentDate = new Date(controls.date);
        if (isNaN(currentDate.getTime())) return { summaryText: "?交??⊥?", nextDatesStr: "" };
        const endDate = (controls.endType === 'on' && controls.endDate) ? new Date(controls.endDate) : null;
        const maxOccurrences = (controls.endType === 'after') ? controls.endOccurrences : Infinity;
        const formatDate = (d) => getTodayYYYYMMDD('-', d); 
        let occurrences = 0;
        if (endDate && currentDate > endDate) { } 
        else if (occurrences < maxOccurrences) {
          occurrences++; 
        }
        switch (controls.type) {
            case 'none':
                summaryText = "銝?銴?;
                break;
            case 'daily':
                summaryText = "瘥予";
                while (nextDates.length < 5 && occurrences < maxOccurrences) {
                    currentDate.setDate(currentDate.getDate() + 1);
                    if (endDate && currentDate > endDate) break;
                    nextDates.push(formatDate(currentDate));
                    occurrences++;
                }
                break;
            case 'weekly':
                summaryText = `瘥?(??${dayNames[currentDate.getDay()]})`;
                while (nextDates.length < 5 && occurrences < maxOccurrences) {
                    currentDate.setDate(currentDate.getDate() + 7);
                    if (endDate && currentDate > endDate) break;
                    nextDates.push(formatDate(currentDate));
                    occurrences++;
                }
                break;
            case 'weekdays':
                summaryText = "撟單 (??銝?喃?)";
                while (nextDates.length < 5 && occurrences < maxOccurrences) {
                    currentDate.setDate(currentDate.getDate() + 1);
                    if (endDate && currentDate > endDate) break;
                    if (currentDate.getDay() !== 0 && currentDate.getDay() !== 6) {
                        nextDates.push(formatDate(currentDate));
                        occurrences++;
                    }
                }
                break;
            case 'weekends':
                summaryText = "?望 (???剜)";
                while (nextDates.length < 5 && occurrences < maxOccurrences) {
                    currentDate.setDate(currentDate.getDate() + 1);
                    if (endDate && currentDate > endDate) break;
                    if (currentDate.getDay() === 0 || currentDate.getDay() === 6) {
                        nextDates.push(formatDate(currentDate));
                        occurrences++;
                    }
                }
                break;
            case 'custom':
                const selectedDays = controls.days.map(d => `??${dayNames[d]}`).join('??);
                summaryText = `瘥?${controls.interval} ${controls.unit === 'day' ? '憭? : (controls.unit === 'week' ? '?? : '??')} (??${selectedDays})`;
                break;
        }
        if (controls.type !== 'none') {
          if (controls.endType === 'on' && endDate) {
              summaryText += `嚗??${controls.endDate} ?迫`;
          } else if (controls.endType === 'after') {
              summaryText += `嚗 ${controls.endOccurrences} 甈︶;
          }
        }
        let nextDatesStr = nextDates.length > 0 ? `?乩?靘??交?嚗?{nextDates.join(', ')}` : " ";
        if (controls.type === 'custom') {
            nextDatesStr = " (?芾?閬?銝?閬賣??";
        }
        return { summaryText, nextDatesStr };
    }
    
    function updateSummaryUI(routeId) {
        const { summaryText, nextDatesStr } = generateRecurrenceSummary(routeId);
        const summaryEl = document.querySelector(`[data-route-id="${routeId}"] .repetition-summary`);
        if (!summaryEl) return;
        summaryEl.querySelector('.summary-text').textContent = summaryText;
        summaryEl.querySelector('.summary-dates').textContent = nextDatesStr;
        summaryEl.style.display = (summaryText === "銝?銴?) ? 'none' : 'block';
    }

    function updateRepetitionOptions(routeId) {
        const dateInput = $(`${routeId}_date`);
        const repeatSelect = $(`${routeId}_repeatType`);
        const weekdaySelector = document.querySelector(`[data-route-id="${routeId}"] .weekday-selector`);
        if (!dateInput || !repeatSelect || !weekdaySelector) return;
        const dateStr = dateInput.value;
        if (!/^\d{4}-\d{2}-\d{2}$/.test(dateStr)) return; 
        const date = new Date(dateStr); 
        if (isNaN(date.getTime())) return; 
        const dayOfWeek = date.getDay();
        const dayNames = ['??, '銝', '鈭?, '銝?, '??, '鈭?, '??];
        const currentValue = repeatSelect.value;
        repeatSelect.innerHTML = ''; 
        repeatSelect.add(new Option('銝?銴?, 'none'));
        repeatSelect.add(new Option('瘥予', 'daily'));
        repeatSelect.add(new Option(`瘥?(??${dayNames[dayOfWeek]})`, 'weekly'));
        const isWeekday = (dayOfWeek > 0 && dayOfWeek < 6);
        const isWeekend = (dayOfWeek === 0 || dayOfWeek === 6);
        if (isWeekday) {
            repeatSelect.add(new Option('撟單 (??銝?喃?)', 'weekdays'));
        }
        if (isWeekend) {
            repeatSelect.add(new Option('?望 (???剜)', 'weekends'));
        }
        repeatSelect.add(new Option('?芾?...', 'custom'));
        if (repeatSelect.querySelector(`option[value="${currentValue}"]`)) {
            repeatSelect.value = currentValue;
        } else {
            repeatSelect.value = 'none';
        }
        const checkboxes = weekdaySelector.querySelectorAll('input[type="checkbox"]');
        checkboxes.forEach((chk, index) => {
            chk.disabled = false;
            if (repeatSelect.value !== 'custom') {
                 chk.checked = false;
            }
            if (index === dayOfWeek) {
                chk.checked = true;
                chk.disabled = true; 
            }
        });
        updateSummaryUI(routeId);
    }
    
    function addNewCommuteRoute() {
      if ($('commuteRoutesContainer').childElementCount >= 3) {
          alert('?頝舐??憭?3 璇?);
          return;
      }
      routeCounter++;
      const routeId = `route${routeCounter}`;
      const div = document.createElement('div');
      div.className = 'commute-route-block';
      div.setAttribute('data-route-id', routeId);
      const todayStr = getTodayYYYYMMDD('-'); 
      div.innerHTML = `
        <div class="grid" style="grid-template-columns: 1fr auto;">
          <h4 style="margin:0">頝舐? ${routeCounter}</h4>
          <button type="button" class="linkBtn remove-route-btn" style="color:#c00">蝘駁甇方楝蝺?/button>
        </div>
        <div class="repetition-controls">
          <div class="grid g3">
            <label>?交? <input type="date" class="route-date-input" id="${routeId}_date" name="${routeId}_date" value="${todayStr}"> </label>
            <label>???? <input type="time" name="${routeId}_startTime" value="08:00"> </label>
            <label>蝯??? <input type="time" name="${routeId}_endTime" value="18:00"> </label>
          </div>
          <label>?望?
            <select name="${routeId}_repeatType" id="${routeId}_repeatType" class="repeat-type-select">
            </select>
          </label>
          <div class="custom-repeat-options">
            <div class="grid g2">
              <label>???? <input type="number" id="${routeId}_customInterval" name="${routeId}_customInterval" value="1" min="1"> </label>
              <label>?桐?
                <select name="${routeId}_customUnit" id="${routeId}_customUnit">
                  <option value="day">憭?/option>
                  <option value="week">??/option>
                  <option value="month">??/option>
                </select>
              </label>
            </div>
            <label>???交?嚗?/label>
            <div class="weekday-selector">
              ${['??,'銝','鈭?,'銝?,'??,'鈭?,'??].map((day, i) => `
                <label>
                  <input type="checkbox" name="${routeId}_customDays" value="${i}">
                  <span>${day}</span>
                </label>
              `).join('')}
            </div>
            <label style="margin-top:12px">蝯???嚗?/label>
            <div>
              <input type="radio" id="${routeId}_end_never" name="${routeId}_endType" value="never" checked> <label for="${routeId}_end_never" class="radio-label">??銝?</label>
            </div>
            <div style="display:flex; align-items:center; gap: 5px;">
              <input type="radio" id="${routeId}_end_on" name="${routeId}_endType" value="on"> 
              <label for="${routeId}_end_on" class="radio-label" style="margin:0;">??/label>
              <input type="date" name="${routeId}_endDate" id="${routeId}_endDate" value="${todayStr}" style="display:none; flex-grow: 1;">
              <span class="end-on-label" style="display:none;"> ?迫</span>
            </div>
            <div style="display:flex; align-items:center; gap: 5px;">
              <input type="radio" id="${routeId}_end_after" name="${routeId}_endType" value="after">
              <label for="${routeId}_end_after" class="radio-label" style="margin:0;">??</label>
              <input type="number" name="${routeId}_endOccurrences" id="${routeId}_endOccurrences" min="1" value="13" style="display:none; width: 80px;">
              <span class="end-after-label" style="display:none;"> 甈?/span>
            </div>
          </div>
          <div class="repetition-summary">
            <p><span class="summary-text"></span></p>
            <small class="summary-dates"></small>
          </div>
        </div>
        <div class="transport-method-entry">
          <label>鈭日撘?
            <select name="${routeId}_transportType" class="transport-type-select">
              <option value="">隢??/option>
              <option value="?圈嚗?蝮??嚗?>?圈</option>
              <option value="擃">擃</option>
              <option value="?啣??琿?">?啣??琿?</option>
              <option value="擃??琿?">擃??琿?</option>
              <option value="other">?嗡?</option>
            </select>
          </label>
          <div class="transport-dropdowns" style="display:none; background: #fff; padding: 10px; border-radius: 8px;">
            <fieldset class="fromWrap" style="border:none; padding: 5px;">
              <legend><b>韏琿?</b></legend>
              <select id="${routeId}_start_System" style="display: none;"></select>
              <div class="grid g2">
                <label>頝舐? <select id="${routeId}_start_Line"></select></label>
                <label>蝡? <select id="${routeId}_start_Station"></select></label>
              </div>
            </fieldset>
            <fieldset class="toWrap" style="border:none; padding: 5px;">
              <legend><b>蝯?</b></legend>
              <select id="${routeId}_end_System" style="display: none;"></select>
              <div class="grid g2">
                <label>頝舐? <select id="${routeId}_end_Line"></select></label>
                <label>蝡? <select id="${routeId}_end_Station"></select></label>
              </div>
            </fieldset>
          </div>
          <div class="transport-other" style="display:none; background: #fff; padding: 10px; border-radius: 8px;">
            <div class="grid g2">
              <label>鈭日極??<input name="${routeId}_other_vehicle" placeholder="璈? / 瘙質?"> </label>
              <label>閰喟敦韏琿? <input name="${routeId}_other_start" placeholder="靘??啣? 101"> </label>
            </div>
            <label>閰喟敦蝯? <input name="${routeId}_other_end" placeholder="靘??葛撅汗擗?> </label>
          </div>
        </div>
      `;
      $('commuteRoutesContainer').appendChild(div);
      const repeatSelect = $(`${routeId}_repeatType`);
      const customOptions = div.querySelector('.custom-repeat-options');
      const repetitionControls = div.querySelector('.repetition-controls');
      const updateAllRepetition = () => {
          updateRepetitionOptions(routeId); 
          customOptions.style.display = (repeatSelect.value === 'custom') ? 'block' : 'none'; 
          updateSummaryUI(routeId); 
      };
      repetitionControls.addEventListener('change', (e) => {
          if (e.target.name && e.target.name.startsWith(routeId)) {
              updateAllRepetition();
          }
      });
      const endRadios = div.querySelectorAll(`input[name="${routeId}_endType"]`);
      const endDateInput = $(`${routeId}_endDate`);
      const endOnLabel = div.querySelector(`.end-on-label`);
      const endOccurrencesInput = $(`${routeId}_endOccurrences`);
      const endAfterLabel = div.querySelector(`.end-after-label`);
      endRadios.forEach(radio => {
          radio.addEventListener('change', () => {
              const showOn = (radio.value === 'on' && radio.checked);
              const showAfter = (radio.value === 'after' && radio.checked);
              endDateInput.style.display = showOn ? 'block' : 'none';
              endOnLabel.style.display = showOn ? 'inline' : 'none';
              endOccurrencesInput.style.display = showAfter ? 'block' : 'none';
              endAfterLabel.style.display = showAfter ? 'inline' : 'none';
          });
      });
      const transportSelect = div.querySelector('.transport-type-select');
      const dropdownContainer = div.querySelector('.transport-dropdowns');
      const otherContainer = div.querySelector('.transport-other');
      transportSelect.addEventListener('change', () => {
        const type = transportSelect.value;
        const startPrefix = `${routeId}_start_`;
        const endPrefix = `${routeId}_end_`;
        if (type === 'other') {
          dropdownContainer.style.display = 'none';
          otherContainer.style.display = 'block';
        } else if (type) {
          dropdownContainer.style.display = 'block';
          otherContainer.style.display = 'none';
          if (!$(startPrefix + 'System')._initialized) {
            initStationSelectors(startPrefix);
            initStationSelectors(endPrefix);
            $(startPrefix + 'System')._initialized = true;
          }
          $(startPrefix + 'System').value = type;
          $(endPrefix + 'System').value = type;
          $(startPrefix + 'System').dispatchEvent(new Event('change'));
          $(endPrefix + 'System').dispatchEvent(new Event('change'));
        } else {
          dropdownContainer.style.display = 'none';
          otherContainer.style.display = 'none';
        }
      });
      div.querySelector('.remove-route-btn').addEventListener('click', () => {
        if(confirm('蝣箏?閬宏?斗迨頝舐???')) {
          div.remove();
          updateAddRouteButtonVisibility(); 
        }
      });
      updateAllRepetition(); 
      updateAddRouteButtonVisibility(); 
    }


    // === (C) ?撘?===
    async function initRoleC(){
      show('roleC', true);
      $('cName').textContent=currentProfile.displayName;
      if(!orderId){ showError('蝻箏? orderId'); return; }
      try{
        const payload={ action:'cEnterFromShareLink', oaUserId: currentProfile.userId, name: currentProfile.displayName, orderId };
        const res=await fetch(BACKEND_URL,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
        const json=await res.json();
        if(json.status!=='success') throw new Error(json.message||'failed');
        const o=json.order;
        $('cOrder').innerHTML=`
          <p>閮蝺刻?嚗?{o.orderId}</p>
          <p>?鈭綽?${o.aName}</p>
          <p>韏琿?嚗?{o.fromStation}</p>
          <p>蝯?嚗?{o.toStation}</p>
          <p>?酉嚗?{o.note||''}</p>`;
      }catch(err){ showError('載入訂單失敗：'+err.message); }
    }

    main().catch(err=>{ 
      $('loading').style.display='none'; 
      showError('???仃??'+err.message); 
    });
  </script>
</body>
</html>
